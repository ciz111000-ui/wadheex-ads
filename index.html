<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Wadheex Ads</title>

  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100%; }
  </style>
</head>

<body>
  <div id="map"></div>

  <script>
    mapboxgl.accessToken = "pk.eyJ1IjoibjktN3Z2IiwiYSI6ImNtbTJubnJjMDA4OGEycXNnaXN2M21lZ3QifQ.yZPWMAgrnQxnwZZdr8kwjA";

    const map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/mapbox/streets-v11",
      center: [46.67, 24.74],
      zoom: 11
    });

    let marker;
    let areaFeature; // نخزن هنا شكل النطاق

    async function loadArea() {
      const res = await fetch("./screen-1.geojson");
      if (!res.ok) throw new Error("ما قدر يقرأ screen-1.geojson");

      const geo = await res.json();

      // إذا الملف FeatureCollection
      if (geo.type === "FeatureCollection") {
        if (!geo.features || geo.features.length === 0) throw new Error("FeatureCollection فاضي");
        areaFeature = geo.features[0];
        return geo;
      }

      // إذا الملف Feature واحد
      areaFeature = geo;
      return { type: "FeatureCollection", features: [geo] };
    }

    // ✅ هنا نحمّل النطاق ونرسم البرتقالي مرة وحدة
    map.on("load", async () => {
      try {
        const area = await loadArea();

        map.addSource("screen-area", { type: "geojson", data: area });

        // تعبئة برتقالية
        map.addLayer({
          id: "screen-fill",
          type: "fill",
          source: "screen-area",
          paint: {
            "fill-color": "#ff6600",
            "fill-opacity": 0.3
          }
        });

        // حد خارجي (عشان ما “يختفي” بصريًا)
        map.addLayer({
          id: "screen-outline",
          type: "line",
          source: "screen-area",
          paint: {
            "line-color": "#ff6600",
            "line-width": 2
          }
        });

      } catch (err) {
        alert("خطأ في تحميل النطاق: " + err.message);
        console.error(err);
      }
    });

    // ✅ حدث واحد فقط للضغط
    map.on("click", (e) => {
      if (!areaFeature) {
        alert("النطاق ما انحمّل للحين… انتظر ثانيتين وجرب");
        return;
      }

      if (marker) marker.remove();

      marker = new mapboxgl.Marker()
        .setLngLat([e.lngLat.lng, e.lngLat.lat])
        .addTo(map);

      const pt = turf.point([e.lngLat.lng, e.lngLat.lat]);
      const inside = turf.booleanPointInPolygon(pt, areaFeature);

      alert(inside ? "داخل النطاق ✅" : "خارج النطاق ❌");
    });
  </script>
</body>
</html>
