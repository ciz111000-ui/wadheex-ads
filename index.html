<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wadheex X</title>

<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<style>
body,html{
  margin:0;
  height:100%;
  font-family:system-ui;
  background:#0b0f18;
}

#map{
  position:absolute;
  top:0;
  bottom:0;
  width:100%;
}

.panel{
  position:absolute;
  right:20px;
  top:20px;
  width:360px;
  max-width:95%;
  backdrop-filter:blur(20px);
  background:rgba(20,25,40,0.75);
  border-radius:20px;
  padding:20px;
  color:#fff;
  box-shadow:0 10px 40px rgba(0,0,0,.5);
}

.panel h2{
  margin:0 0 10px;
  font-size:20px;
}

.input{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:none;
  margin:8px 0;
  font-size:14px;
}

.stat{
  background:rgba(255,255,255,0.05);
  padding:10px;
  border-radius:10px;
  margin-top:6px;
  font-size:14px;
}

.btn{
  width:100%;
  padding:12px;
  border:none;
  border-radius:14px;
  margin-top:10px;
  cursor:pointer;
  font-weight:bold;
}

.btn-primary{
  background:#ff3b3b;
  color:#fff;
}

.preview{
  height:100px;
  background:#000;
  margin-top:10px;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
}

@media(max-width:768px){
  .panel{
    bottom:0;
    top:auto;
    width:100%;
    border-radius:20px 20px 0 0;
  }
}
</style>
</head>
<body>

<div id="map"></div>

<div class="panel">
<h2>Wadheex X</h2>

<input id="business" class="input" placeholder="اسم المنشأة" />

<div id="distance" class="stat">المسافة: -</div>
<div id="price" class="stat">السعر: -</div>
<div id="eta" class="stat">وقت الوصول: -</div>

<button class="btn btn-primary" onclick="submitOrder()">حجز عبر واتساب</button>

<div class="preview" id="previewBox">إعلانك هنا</div>
</div>

<script>
mapboxgl.accessToken = "pk.eyJ1IjoibjktN3Z2IiwiYSI6ImNtbTJubnJjMDA4OGEycXNnaXN2M21lZ3QifQ.yZPWMAgrnQxnwZZdr8kwjA";

const screens = [
  {name:"Screen-1", coords:[46.61106,24.77635]},
  {name:"Screen-2", coords:[46.65000,24.80000]},
  {name:"Screen-3", coords:[46.70000,24.75000]}
];

const map = new mapboxgl.Map({
  container:"map",
  style:"mapbox://styles/mapbox/dark-v11",
  center:[46.67,24.75],
  zoom:11
});

map.addControl(new mapboxgl.NavigationControl());

let userMarker=null;
let selectedScreen=null;

screens.forEach(s=>{
  new mapboxgl.Marker({color:"#ff0000"})
    .setLngLat(s.coords)
    .setPopup(new mapboxgl.Popup().setText(s.name))
    .addTo(map);
});

function calculate(lng,lat){
  let min=999;
  screens.forEach(s=>{
    const dist=turf.distance(turf.point([lng,lat]),turf.point(s.coords));
    if(dist<min){
      min=dist;
      selectedScreen=s;
    }
  });
  return min;
}

function pricing(d){
  if(d<=2)return 4000;
  if(d<=5)return 3000;
  return 2000;
}

map.on("click",e=>{
  if(userMarker)userMarker.remove();
  userMarker=new mapboxgl.Marker({color:"#007bff"})
    .setLngLat(e.lngLat)
    .addTo(map);

  const d=calculate(e.lngLat.lng,e.lngLat.lat);
  const p=pricing(d);
  const eta=Math.round((d/50)*60);

  document.getElementById("distance").innerText="المسافة: "+d.toFixed(2)+" كم";
  document.getElementById("price").innerText="السعر: "+p+" ريال";
  document.getElementById("eta").innerText="وقت الوصول: "+eta+" دقيقة";

  const name=document.getElementById("business").value||"إعلانك هنا";
  document.getElementById("previewBox").innerText=name;
});

function submitOrder(){
  if(!selectedScreen){
    alert("حدد موقع أولاً");
    return;
  }
  const name=document.getElementById("business").value;
  const price=document.getElementById("price").innerText;

  const msg=encodeURIComponent(
    "طلب حجز إعلان\n"+
    "المنشأة: "+name+"\n"+
    price+"\n"+
    "الشاشة: "+selectedScreen.name
  );

  window.open("https://wa.me/966583611252?text="+msg,"_blank");
}
</script>

</body>
</html>
