<script>
mapboxgl.accessToken = "PUT_YOUR_TOKEN_HERE";

const map = new mapboxgl.Map({
  container: "map",
  style: "mapbox://styles/mapbox/streets-v11",
  center: [46.67, 24.74],
  zoom: 11
});

let marker;
let areaFeature; // هنا نخزن شكل النطاق

async function loadArea() {
  const res = await fetch("./screen-1.geojson");
  const geo = await res.json();

  // إذا الملف FeatureCollection
  if (geo.type === "FeatureCollection") {
    areaFeature = geo.features[0];   // أول Feature
    return geo;                      // نرجع FeatureCollection كما هو
  }

  // إذا الملف Feature واحد
  areaFeature = geo;
  return { type: "FeatureCollection", features: [geo] };
}

// ✅ ارسم النطاق البرتقالي مرة وحدة
map.on("load", async () => {
  const area = await loadArea();

  map.addSource("screen-area", { type: "geojson", data: area });

  map.addLayer({
    id: "screen-fill",
    type: "fill",
    source: "screen-area",
    paint: {
      "fill-color": "#ff6600",
      "fill-opacity": 0.3
    }
  });
});

// ✅ عند الضغط: فقط ماركر + فحص داخل/خارج
map.on("click", (e) => {
  if (!areaFeature) {
    alert("النطاق ما انحمّل للحين… جرّب بعد ثانيتين");
    return;
  }

  if (marker) marker.remove();
  marker = new mapboxgl.Marker()
    .setLngLat([e.lngLat.lng, e.lngLat.lat])
    .addTo(map);

  const pt = turf.point([e.lngLat.lng, e.lngLat.lat]);
  const inside = turf.booleanPointInPolygon(pt, areaFeature);

  alert(inside ? "داخل النطاق ✅" : "خارج النطاق ❌");
});
</script>
