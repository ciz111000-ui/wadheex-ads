<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wadheex Ads â€” ÙˆÙ…ÙŠØ¶</title>

  <!-- Mapbox -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <!-- Turf -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    :root{
      --bg: #0b0f16;
      --panel: rgba(18, 24, 36, 0.86);
      --stroke: rgba(255,255,255,0.08);
      --text: #e9eef7;
      --muted:#a9b2c3;
      --brand:#ff6600;
      --danger:#ff3b30;
      --ok:#2ecc71;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius: 16px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, "Noto Kufi Arabic", "Noto Sans Arabic", Arial, sans-serif;
    }

    html, body { height: 100%; margin: 0; background: var(--bg); font-family: var(--font); }
    #map { position: fixed; inset: 0; }

    /* Ù„ÙˆØ­Ø© ÙŠÙ…ÙŠÙ† */
    .panel{
      position: fixed;
      top: 18px;
      right: 18px;
      width: min(360px, calc(100% - 36px));
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      color: var(--text);
      overflow: hidden;
      z-index: 10;
      backdrop-filter: blur(10px);
    }
    .panel header{
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--stroke);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .title{
      display:flex; flex-direction:column; gap:2px;
    }
    .title strong{ font-size: 14px; }
    .title span{ font-size: 12px; color: var(--muted); }

    .badge{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      color: var(--muted);
      background: rgba(255,255,255,.03);
    }

    .panel .body{ padding: 12px 14px 14px; display:flex; flex-direction:column; gap:10px; }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .card{
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 10px;
      background: rgba(255,255,255,.03);
      min-height: 56px;
    }
    .card .k{ font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .card .v{ font-size: 13px; line-height: 1.3; word-break: break-word; }
    .hint{
      border: 1px dashed rgba(255,255,255,.15);
      border-radius: 12px;
      padding: 10px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.6;
    }
    .hint b{ color: var(--text); }

    .actions{ display:flex; gap:10px; }
    button{
      cursor:pointer;
      border: none;
      border-radius: 12px;
      padding: 11px 12px;
      font-weight: 700;
      font-size: 13px;
    }
    .btn-primary{ background: var(--brand); color: white; flex: 1; }
    .btn-ghost{ background: rgba(255,255,255,.06); color: var(--text); border: 1px solid var(--stroke); }
    .btn-danger{ background: rgba(255,59,48,.14); color: #ffd1cf; border: 1px solid rgba(255,59,48,.28); }

    /* Ø²Ø± Ø³ÙÙ„ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) */
    .floating{
      position: fixed;
      bottom: 18px;
      left: 18px;
      z-index: 10;
      display:flex;
      gap:10px;
    }
    .toast{
      position: fixed;
      left: 18px;
      top: 18px;
      z-index: 11;
      background: rgba(0,0,0,.55);
      border: 1px solid var(--stroke);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      font-size: 12px;
      line-height: 1.5;
      max-width: 420px;
      backdrop-filter: blur(10px);
    }

    /* ØªØ­Ø³ÙŠÙ† Ø¸Ù‡ÙˆØ± Ø®Ø±ÙŠØ·Ø© mapbox ØªØ­Øª Ø§Ù„Ù„ÙˆØ­Ø© */
    .mapboxgl-ctrl-bottom-right,
    .mapboxgl-ctrl-bottom-left { z-index: 9; }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="toast" id="toast">
    <b>Wadheex Ads â€” Ù…Ù†ØµØ© ÙˆÙ…ÙŠØ¶</b><br/>
    Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ù…Ù†Ø´Ø£ØªÙƒ. Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¨ÙŠÙ‘Ù† Ù„Ùƒ Ø¥Ø°Ø§ ÙƒÙ†Øª Ø¯Ø§Ø®Ù„ Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØºØ·ÙŠØ© Ø£Ùˆ Ø®Ø§Ø±Ø¬Ù‡Ø§.
  </div>

  <aside class="panel">
    <header>
      <div class="title">
        <strong>Wadheex Ads â€” Ù…Ù†ØµØ© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø°Ø§ØªÙŠ</strong>
        <span>Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆÙ‚Ø¹ + ØªØ³Ø¹ÙŠØ± + Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³</span>
      </div>
      <div class="badge" id="statusBadge">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</div>
    </header>

    <div class="body">
      <div class="row">
        <div class="card">
          <div class="k">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ù†Ø´Ø£Ø©</div>
          <div class="v" id="placeText">â€”</div>
        </div>
        <div class="card">
          <div class="k">Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª</div>
          <div class="v" id="coordsText">â€”</div>
        </div>
      </div>

      <div class="row">
        <div class="card">
          <div class="k">Ø§Ù„Ø­Ø§Ù„Ø©</div>
          <div class="v" id="insideText">â€”</div>
        </div>
        <div class="card">
          <div class="k">ØªØ³Ø¹ÙŠØ± Ù…Ø¨Ø¯Ø¦ÙŠ</div>
          <div class="v" id="pricePreview">â€”</div>
        </div>
      </div>

      <div class="hint">
        <b>Ø´Ø±Ø­ Ø³Ø±ÙŠØ¹:</b><br/>
        â€¢ Ø¥Ø°Ø§ ÙƒÙ†Øª <span style="color:var(--ok);font-weight:700">Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚</span> ØªÙ‚Ø¯Ø± ØªÙ‚Ø¯Ù… Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø©.<br/>
        â€¢ Ø¥Ø°Ø§ ÙƒÙ†Øª <span style="color:var(--danger);font-weight:700">Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚</span ØªØ¸Ù‡Ø± Ù„Ùƒ Ø±Ø³Ø§Ù„Ø©ØŒ ÙˆØªÙ‚Ø¯Ø± ØªØ±Ø³Ù„ Ø·Ù„Ø¨ â€œØ§Ù‚ØªØ±Ø§Ø­ ØªÙˆØ³Ø¹Ø©â€ Ø¨Ø§Ù„ÙˆØ§ØªØ³.
      </div>

      <div class="actions">
        <button class="btn-ghost" id="copyBtn">Ù†Ø³Ø® Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª</button>
        <button class="btn-danger" id="resetBtn">ØªØµÙÙŠØ± Ø§Ù„ØªØ­Ø¯ÙŠØ¯</button>
      </div>

      <div class="actions">
        <button class="btn-primary" id="submitBtn">ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨ (WhatsApp)</button>
      </div>

      <div class="card">
        <div class="k">Ø·Ù„Ø¨Ø§ØªÙƒ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© (Local)</div>
        <div class="v">
          <span id="savedCount">0</span> Ø·Ù„Ø¨
          <div style="margin-top:8px; display:flex; gap:10px;">
            <button class="btn-ghost" id="saveLocalBtn" style="flex:1;">Ø­ÙØ¸ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨</button>
            <button class="btn-ghost" id="exportBtn" style="flex:1;">ØªØµØ¯ÙŠØ± JSON</button>
          </div>
          <button class="btn-ghost" id="clearSavedBtn" style="margin-top:10px; width:100%;">Ù…Ø³Ø­ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
        </div>
      </div>
    </div>
  </aside>

  <div class="floating">
    <button class="btn-ghost" id="fitBtn">ØªÙ‚Ø±ÙŠØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø·Ø§Ù‚</button>
  </div>

  <script>
    /***********************
     * 1) Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
     ***********************/
    // âœ… ØªÙˆÙƒÙ† Mapbox (Ù†ÙØ³ Ø§Ù„Ù„ÙŠ Ø£Ø±Ø³Ù„ØªÙ‡)
    mapboxgl.accessToken =
      "pk.eyJ1IjoibjktN3Z2IiwiYSI6ImNtbTJubnJjMDA4OGEycXNnaXN2M21lZ3QifQ.yZPWMAgrnQxnwZZdr8kwjA";

    // âœ… Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ (Ø¶Ø¹ Ø±Ù‚Ù…Ùƒ Ø£Ù†Øª Ù…Ø­Ù„ÙŠÙ‹Ø§ Ù‡Ù†Ø§ Ø¨ØµÙŠØºØ© Ø¯ÙˆÙ„ÙŠØ© Ø¨Ø¯ÙˆÙ† +)
    // Ù…Ø«Ø§Ù„ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©: 9665XXXXXXXX
    const WHATSAPP_PHONE = "966583611252"; // <-- ØºÙŠÙ‘Ø± Ù‡Ø°Ø§ Ø¹Ù†Ø¯Ùƒ Ù„Ø±Ù‚Ù…Ùƒ

    // âœ… Ø§Ø³Ù… Ù…Ù„Ù Ø§Ù„Ù†Ø·Ø§Ù‚
   const AREA_FILE = "./screen-1.geojson";

    // âœ… ØªØ³Ø¹ÙŠØ± Ø¨Ø³ÙŠØ· (ØªÙ‚Ø¯Ø± ØªØ¹Ø¯Ù„Ù‡)
    const PRICE_INSIDE_WEEK = 2000;   // Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚
    const PRICE_OUTSIDE_TEXT = "â€” Ø®Ø§Ø±Ø¬ Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØºØ·ÙŠØ©";

    /***********************
     * 2) Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
     ***********************/
    const map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/mapbox/streets-v11",
      center: [46.67, 24.74],
      zoom: 11
    });

    map.addControl(new mapboxgl.NavigationControl(), "bottom-right");

    /***********************
     * 3) Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
     ***********************/
    const elStatusBadge = document.getElementById("statusBadge");
    const elPlaceText   = document.getElementById("placeText");
    const elCoordsText  = document.getElementById("coordsText");
    const elInsideText  = document.getElementById("insideText");
    const elPrice       = document.getElementById("pricePreview");
    const elSavedCount  = document.getElementById("savedCount");
    const elToast       = document.getElementById("toast");

    const btnCopy       = document.getElementById("copyBtn");
    const btnReset      = document.getElementById("resetBtn");
    const btnSubmit     = document.getElementById("submitBtn");
    const btnFit        = document.getElementById("fitBtn");

    const btnSaveLocal  = document.getElementById("saveLocalBtn");
    const btnExport     = document.getElementById("exportBtn");
    const btnClearSaved = document.getElementById("clearSavedBtn");

    /***********************
     * 4) Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø©
     ***********************/
    let marker = null;
    let areaFeature = null;        // Feature Polygon Ø¬Ø§Ù‡Ø² Ù„Ù„ÙØ­Øµ
    let areaFC = null;             // FeatureCollection Ù„Ù„Ø±Ø³Ù…
    let lastClick = null;          // {lng,lat, inside}

    /***********************
     * 5) Ø¯ÙˆØ§Ù„ Ø¥ØµÙ„Ø§Ø­ geojson (Ù…Ù‡Ù…!)
     * - ØªØ­Ù„ Ù…Ø´ÙƒÙ„Ø©: Ø§Ù„ØªØºØ·ÙŠØ© ØªØ·Ù„Ø¹ "Ø¬Ø²Ø¡ ØµØºÙŠØ±" Ø£Ùˆ Ø´ÙƒÙ„ ØºØ±ÙŠØ¨
     * - Ø§Ù„Ø³Ø¨Ø¨ ØºØ§Ù„Ø¨Ù‹Ø§: Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª lat/lng Ù…Ù‚Ù„ÙˆØ¨Ø© Ø£Ùˆ Ø§Ù„Ø­Ù„Ù‚Ø© ØºÙŠØ± Ù…ØºÙ„Ù‚Ø©
     ***********************/
    function swapIfLatLng(p) {
      const a = p[0], b = p[1];
      // Ø§Ù„Ø±ÙŠØ§Ø¶ ØºØ§Ù„Ø¨Ø§Ù‹: lat 20-30 ØŒ lng 40-60
      // Ù„Ùˆ Ø¬Ø§ÙŠØ© [lat,lng] Ù†Ù‚Ù„Ø¨Ù‡Ø§
      if (a > 15 && a < 35 && b > 35 && b < 60) return [b, a];
      return p;
    }

    function closeRing(ring) {
      if (!ring || ring.length < 3) return ring;
      const first = ring[0];
      const last  = ring[ring.length - 1];
      if (first[0] !== last[0] || first[1] !== last[1]) ring.push(first);
      return ring;
    }

    function normalizeFeature(input) {
      if (!input) throw new Error("GeoJSON ÙØ§Ø¶ÙŠ");

      // FeatureCollection
      if (input.type === "FeatureCollection") {
        if (!input.features || !input.features.length) throw new Error("FeatureCollection Ø¨Ø¯ÙˆÙ† features");
        input = input.features[0];
      }

      // Feature
      if (input.type === "Feature") {
        // ok
      } else {
        throw new Error("Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Feature Ø£Ùˆ FeatureCollection");
      }

      // MultiPolygon -> Ø®Ø° Ø£ÙˆÙ„ Polygon
      if (input.geometry && input.geometry.type === "MultiPolygon") {
        input = {
          type: "Feature",
          properties: input.properties || {},
          geometry: {
            type: "Polygon",
            coordinates: input.geometry.coordinates[0]
          }
        };
      }

      if (!input.geometry || input.geometry.type !== "Polygon") {
        throw new Error("Ø§Ù„Ù…Ù„Ù Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Polygon Ø£Ùˆ MultiPolygon");
      }

      // Ø£ØµÙ„Ø­ Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© ÙÙ‚Ø·
      let ring = input.geometry.coordinates[0];
      ring = ring.map(swapIfLatLng);
      ring = closeRing(ring);
      input.geometry.coordinates[0] = ring;

      return input;
    }

    async function loadArea() {
      const res = await fetch(AREA_FILE, { cache: "no-store" });
      if (!res.ok) throw new Error("Ù…Ø§Ù‚Ø¯Ø±Øª Ø£Ù‚Ø±Ø£ Ù…Ù„Ù Ø§Ù„Ù†Ø·Ø§Ù‚: ØªØ£ÙƒØ¯ Ø§Ø³Ù…Ù‡ (screen-1.geojson) ÙˆÙ…ÙƒØ§Ù†Ù‡ (root)");

      const geo = await res.json();
      const feature = normalizeFeature(geo);

      areaFeature = feature;
      areaFC = { type: "FeatureCollection", features: [feature] };
      return areaFC;
    }

    function setBadge(text, ok = true) {
      elStatusBadge.textContent = text;
      elStatusBadge.style.color = ok ? "var(--muted)" : "#ffd1cf";
      elStatusBadge.style.borderColor = ok ? "var(--stroke)" : "rgba(255,59,48,.28)";
      elStatusBadge.style.background = ok ? "rgba(255,255,255,.03)" : "rgba(255,59,48,.14)";
    }

    function setInsideUI(inside) {
      if (inside === true) {
        elInsideText.innerHTML = `<span style="color:var(--ok);font-weight:800">Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚ âœ…</span>`;
        elPrice.textContent = `${PRICE_INSIDE_WEEK} Ø±ÙŠØ§Ù„ / Ø£Ø³Ø¨ÙˆØ¹`;
      } else if (inside === false) {
        elInsideText.innerHTML = `<span style="color:var(--danger);font-weight:800">Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚ âŒ</span>`;
        elPrice.textContent = PRICE_OUTSIDE_TEXT;
      } else {
        elInsideText.textContent = "â€”";
        elPrice.textContent = "â€”";
      }
    }

    function setCoordsUI(lng, lat) {
      elCoordsText.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    }

    function hideToastSoon() {
      setTimeout(() => { if (elToast) elToast.style.display = "none"; }, 4500);
    }

    /***********************
     * 6) Ø±Ø³Ù… Ø§Ù„Ù†Ø·Ø§Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
     ***********************/
    map.on("load", async () => {
      try {
        setBadge("ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø·Ø§Ù‚â€¦");
        const fc = await loadArea();

        map.addSource("screen-area", { type: "geojson", data: fc });

        // ØªØ¹Ø¨Ø¦Ø©
        map.addLayer({
          id: "screen-fill",
          type: "fill",
          source: "screen-area",
          paint: { "fill-color": "#ff6600", "fill-opacity": 0.28 }
        });

        // Ø­Ø¯ÙˆØ¯
        map.addLayer({
          id: "screen-outline",
          type: "line",
          source: "screen-area",
          paint: { "line-color": "#ff3300", "line-width": 2 }
        });

        // ØªÙ‚Ø±ÙŠØ¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø·Ø§Ù‚
        const bbox = turf.bbox(fc);
        map.fitBounds(bbox, { padding: 40, duration: 650 });

        setBadge("Ø¬Ø§Ù‡Ø²");
        hideToastSoon();
      } catch (err) {
        console.error(err);
        setBadge("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø·Ø§Ù‚", false);
        alert("ÙÙŠÙ‡ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ù…Ù„Ù Ø§Ù„Ù†Ø·Ø§Ù‚ screen-1.geojson:\n" + err.message);
      }
    });

    /***********************
     * 7) ÙƒÙ„ÙŠÙƒ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±)
     * - ÙŠØ­Ø· Marker
     * - ÙŠØ­Ø³Ø¨ Ø¯Ø§Ø®Ù„/Ø®Ø§Ø±Ø¬
     * - ÙŠØ­Ø¯Ø« Ø§Ù„Ù„ÙˆØ­Ø©
     ***********************/
    map.on("click", async (e) => {
      if (!areaFeature) {
        alert("Ø§Ù„Ù†Ø·Ø§Ù‚ Ù…Ø§ Ø§Ù†Ø­Ù…Ù‘Ù„ Ù„Ù„Ø­ÙŠÙ†â€¦ Ø§Ù†ØªØ¸Ø± Ø«Ø§Ù†ÙŠØªÙŠÙ† ÙˆØ¬Ø±Ù‘Ø¨");
        return;
      }

      // marker
      if (marker) marker.remove();
      marker = new mapboxgl.Marker().setLngLat(e.lngLat).addTo(map);

      const lng = e.lngLat.lng;
      const lat = e.lngLat.lat;

      setCoordsUI(lng, lat);
      elPlaceText.textContent = "ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©";

      const point = turf.point([lng, lat]);
      const inside = turf.booleanPointInPolygon(point, areaFeature);

      setInsideUI(inside);

      lastClick = { lng, lat, inside, ts: Date.now() };
    });

    /***********************
     * 8) Ù†Ø³Ø® Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
     ***********************/
    btnCopy.addEventListener("click", async () => {
      if (!lastClick) return alert("Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£ÙˆÙ„Ø§Ù‹");
      const text = `${lastClick.lat.toFixed(6)}, ${lastClick.lng.toFixed(6)}`;
      try {
        await navigator.clipboard.writeText(text);
        setBadge("ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…");
        setTimeout(() => setBadge("Ø¬Ø§Ù‡Ø²"), 1200);
      } catch {
        alert("Ù…Ø§Ù‚Ø¯Ø±Øª Ø£Ù†Ø³Ø® ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. Ø§Ù†Ø³Ø®Ù‡Ø§ ÙŠØ¯ÙˆÙŠÙ‹Ø§:\n" + text);
      }
    });

    /***********************
     * 9) ØªØµÙÙŠØ± Ø§Ù„ØªØ­Ø¯ÙŠØ¯
     ***********************/
    btnReset.addEventListener("click", () => {
      if (marker) marker.remove();
      marker = null;
      lastClick = null;
      elPlaceText.textContent = "â€”";
      elCoordsText.textContent = "â€”";
      setInsideUI(null);
      setBadge("Ø¬Ø§Ù‡Ø²");
    });

    /***********************
     * 10) ØªÙ‚Ø±ÙŠØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø·Ø§Ù‚
     ***********************/
    btnFit.addEventListener("click", () => {
      if (!areaFC) return;
      const bbox = turf.bbox(areaFC);
      map.fitBounds(bbox, { padding: 40, duration: 550 });
    });

    /***********************
     * 11) WhatsApp Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
     * - Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚: Ø·Ù„Ø¨ Ø¥Ø¹Ù„Ø§Ù†
     * - Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚: Ø§Ù‚ØªØ±Ø§Ø­ ØªÙˆØ³Ø¹Ø©
     ***********************/
    btnSubmit.addEventListener("click", () => {
      if (!lastClick) return alert("Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£ÙˆÙ„Ø§Ù‹");

      const { lat, lng, inside } = lastClick;

      const type = inside ? "Ø·Ù„Ø¨ Ø¥Ø¹Ù„Ø§Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚" : "Ø§Ù‚ØªØ±Ø§Ø­ ØªÙˆØ³Ø¹Ø© (Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚)";
      const price = inside ? `${PRICE_INSIDE_WEEK} Ø±ÙŠØ§Ù„/Ø£Ø³Ø¨ÙˆØ¹` : "Ø®Ø§Ø±Ø¬ Ø§Ù„ØªØºØ·ÙŠØ©";
      const link = `https://www.google.com/maps?q=${lat},${lng}`;

      const msg =
`Wadheex Ads â€” ÙˆÙ…ÙŠØ¶
${type}

ğŸ“ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª: ${lat.toFixed(6)}, ${lng.toFixed(6)}
ğŸ§­ Ø§Ù„Ø±Ø§Ø¨Ø·: ${link}
ğŸ’³ Ø§Ù„ØªØ³Ø¹ÙŠØ±: ${price}

Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):
- Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø©:
- Ø§Ù„Ø­ÙŠ:
- Ù…Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†:`;

      // Ø§ÙØªØ­ ÙˆØ§ØªØ³
      const wa = `https://wa.me/${WHATSAPP_PHONE}?text=${encodeURIComponent(msg)}`;
      window.open(wa, "_blank");
    });

    /***********************
     * 12) Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ + ØªØµØ¯ÙŠØ± JSON
     ***********************/
    const STORAGE_KEY = "wadheex_saved_requests_v1";

    function readSaved() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
      catch { return []; }
    }
    function writeSaved(list) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
      elSavedCount.textContent = String(list.length);
    }
    function refreshSavedCount() {
      elSavedCount.textContent = String(readSaved().length);
    }
    refreshSavedCount();

    btnSaveLocal.addEventListener("click", () => {
      if (!lastClick) return alert("Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£ÙˆÙ„Ø§Ù‹");
      const list = readSaved();
      list.unshift({
        ...lastClick,
        price: lastClick.inside ? PRICE_INSIDE_WEEK : null
      });
      writeSaved(list);
      setBadge("ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…");
      setTimeout(() => setBadge("Ø¬Ø§Ù‡Ø²"), 1200);
    });

    btnExport.addEventListener("click", () => {
      const list = readSaved();
      const blob = new Blob([JSON.stringify(list, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "wadheex-requests.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    btnClearSaved.addEventListener("click", () => {
      if (!confirm("Ù…ØªØ£ÙƒØ¯ ØªØ¨ØºÙ‰ ØªÙ…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©ØŸ")) return;
      writeSaved([]);
      setBadge("ØªÙ… Ø§Ù„Ù…Ø³Ø­");
      setTimeout(() => setBadge("Ø¬Ø§Ù‡Ø²"), 1200);
    });
  </script>
</body>
</html>
