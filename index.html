<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wadheex Ads â€” Ù…Ù†ØµØ© Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</title>

  <!-- Mapbox GL -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <!-- Mapbox Geocoder (Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù†) -->
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.css">
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.min.js"></script>

  <!-- Turf (Ø­Ø³Ø§Ø¨Ø§Øª Ø¯Ø§Ø®Ù„/Ø®Ø§Ø±Ø¬/Ù…Ø³Ø§ÙØ§Øª) -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    :root{
      --brand:#ff6600;
      --bg:#0b0f14;
      --card:#0f1620;
      --muted:#9fb0c2;
      --text:#e9f0f7;
      --line:rgba(255,255,255,.10);
      --ok:#2ecc71;
      --bad:#ff4757;
      --shadow: 0 16px 60px rgba(0,0,0,.55);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial}
    body{background:var(--bg); color:var(--text)}
    #map{position:fixed; inset:0}

    /* Top bar */
    .topbar{
      position:fixed; left:12px; right:12px; top:12px;
      display:flex; gap:10px; align-items:center; z-index:10;
      pointer-events:none;
    }
    .brand{
      pointer-events:auto;
      display:flex; align-items:center; gap:10px;
      background:rgba(15,22,32,.88);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      border-radius:999px;
      padding:10px 12px;
      backdrop-filter: blur(8px);
    }
    .dot{
      width:10px;height:10px;border-radius:999px;background:var(--brand);
      box-shadow:0 0 0 6px rgba(255,102,0,.18);
    }
    .brand b{font-size:14px}
    .brand small{display:block;color:var(--muted); font-size:12px; margin-top:2px}
    .hint{
      pointer-events:auto;
      margin-left:auto;
      background:rgba(15,22,32,.88);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      border-radius:999px;
      padding:10px 12px;
      color:var(--muted);
      font-size:13px;
      backdrop-filter: blur(8px);
      max-width:520px;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }

    /* Sidebar */
    .panel{
      position:fixed; right:12px; top:70px; bottom:12px;
      width:min(420px, calc(100vw - 24px));
      z-index:10;
      background:rgba(15,22,32,.92);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      border-radius:var(--radius);
      backdrop-filter: blur(10px);
      display:flex; flex-direction:column;
      overflow:hidden;
    }
    .panel header{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; gap:10px;
    }
    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      background:rgba(255,255,255,.03);
    }
    .panel .content{
      padding:14px;
      overflow:auto;
      display:flex; flex-direction:column; gap:12px;
    }
    .card{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:rgba(255,255,255,.03);
    }
    .row{display:flex; gap:10px; align-items:center; justify-content:space-between}
    .kpi{
      display:grid; grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .kpi .box{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background:rgba(255,255,255,.02);
    }
    .label{font-size:12px;color:var(--muted)}
    .value{font-size:16px;margin-top:4px}
    .ok{color:var(--ok)}
    .bad{color:var(--bad)}
    .btns{display:flex; gap:10px; flex-wrap:wrap}
    button{
      border:0; cursor:pointer;
      border-radius:12px;
      padding:12px 12px;
      font-weight:700;
    }
    .primary{background:var(--brand); color:#111}
    .ghost{background:rgba(255,255,255,.06); color:var(--text); border:1px solid var(--line)}
    .danger{background:rgba(255,71,87,.14); color:#ffd3d8; border:1px solid rgba(255,71,87,.35)}
    .mini{padding:8px 10px; font-weight:700; font-size:12px; border-radius:999px}

    /* Modal */
    .modalWrap{
      position:fixed; inset:0; display:none; place-items:center; z-index:50;
      background:rgba(0,0,0,.55);
      padding:14px;
    }
    .modal{
      width:min(760px, 100%);
      background:rgba(15,22,32,.96);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modal header{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between;
    }
    .modal .body{padding:14px; display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    .modal .body .full{grid-column:1 / -1}
    input, textarea, select{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:110px; resize:vertical}
    .modal footer{
      padding:14px;
      border-top:1px solid var(--line);
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
    }

    /* Mapbox geocoder look */
    .mapboxgl-ctrl-top-left{left:12px; top:70px}
    .mapboxgl-ctrl-geocoder{
      min-width:min(520px, calc(100vw - 24px));
      border-radius:14px;
      overflow:hidden;
      border:1px solid var(--line);
      background:rgba(15,22,32,.92);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }
    .mapboxgl-ctrl-geocoder--input{
      color:var(--text);
      padding:14px 14px 14px 44px;
    }
    .mapboxgl-ctrl-geocoder--icon-search{top:14px}
    .mapboxgl-ctrl-geocoder--suggestion{color:#0b0f14}

    /* Hide panel on tiny screens by default */
    @media (max-width: 920px){
      .panel{right:12px; left:12px; width:auto; height: 46vh; top:auto; bottom:12px}
      .hint{display:none}
      .mapboxgl-ctrl-top-left{top:12px}
      .topbar{top:auto; bottom: calc(46vh + 18px)}
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="topbar">
    <div class="brand">
      <div class="dot"></div>
      <div>
        <b>Wadheex Ads â€” Ù…Ù†ØµØ© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø°Ø§ØªÙŠ</b>
        <small>Ø§Ø®ØªØ± Ù…ÙˆÙ‚Ø¹ Ù…Ù†Ø´Ø£ØªÙƒâ€¦ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ·Ù„Ø¹ Ù„Ùƒ Ø£Ù‚Ø±Ø¨ Ø´Ø§Ø´Ø© Ø¯Ø§Ø®Ù„ 10 Ø¯Ù‚Ø§Ø¦Ù‚</small>
      </div>
    </div>
    <div class="hint" id="hint">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£Ùˆ Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù†. Ø«Ù… Ù‚Ø¯Ù‘Ù… Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ø¶ØºØ·Ø© ÙˆØ­Ø¯Ø©.</div>
  </div>

  <aside class="panel">
    <header>
      <span class="badge" id="sysState">Ø¬Ø§Ù‡Ø²</span>
      <span class="badge" id="screensState">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø§Ø´Ø§Øªâ€¦</span>
      <span class="badge" id="storageState">Ø·Ù„Ø¨Ø§ØªÙƒ Ù…Ø­ÙÙˆØ¸Ø©</span>
    </header>

    <div class="content">
      <div class="card">
        <div class="row">
          <div>
            <div class="label">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ù†Ø´Ø£Ø©</div>
            <div class="value" id="bizLoc">â€”</div>
          </div>
          <button class="ghost mini" id="copyCoords">Ù†Ø³Ø® Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª</button>
        </div>
      </div>

      <div class="kpi">
        <div class="box">
          <div class="label">Ø£Ù‚Ø±Ø¨ Ø´Ø§Ø´Ø©</div>
          <div class="value" id="nearestScreen">â€”</div>
        </div>
        <div class="box">
          <div class="label">Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ©</div>
          <div class="value" id="distanceKm">â€”</div>
        </div>
        <div class="box">
          <div class="label">Ø§Ù„Ø­Ø§Ù„Ø©</div>
          <div class="value" id="insideState">â€”</div>
        </div>
        <div class="box">
          <div class="label">ØªØ³Ø¹ÙŠØ± Ù…Ø¨Ø¯Ø¦ÙŠ</div>
          <div class="value" id="priceEst">â€”</div>
        </div>
      </div>

      <div class="card">
        <div class="label">Ø´Ø±Ø­ Ø³Ø±ÙŠØ¹</div>
        <div style="margin-top:8px;color:var(--muted);line-height:1.7;font-size:13px">
          Ø¥Ø°Ø§ ÙƒÙ†Øª <span class="ok">Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚</span> ØªÙ‚Ø¯Ø± ØªÙ‚Ø¯Ù… Ø·Ù„Ø¨ Ø¥Ø¹Ù„Ø§Ù† Ù…Ø¨Ø§Ø´Ø±Ø©.
          Ø¥Ø°Ø§ <span class="bad">Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚</span> ÙŠØ¸Ù‡Ø± Ù„Ùƒ Ø£Ù‚Ø±Ø¨ Ø´Ø§Ø´Ø© Ù„ÙƒÙ† Ø§Ù„Ø·Ù„Ø¨ ÙŠØªÙˆÙ‚Ù Ù„ÙŠÙ† Ù†ÙˆØ³Ø¹ Ø§Ù„ØªØºØ·ÙŠØ©.
        </div>
      </div>

      <div class="btns">
        <button class="primary" id="openForm">ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨ Ø¥Ø¹Ù„Ø§Ù†</button>
        <button class="ghost" id="reset">ØªØµÙÙŠØ± Ø§Ù„ØªØ­Ø¯ÙŠØ¯</button>
        <button class="danger" id="exportOrders">ØªØµØ¯ÙŠØ± Ø·Ù„Ø¨Ø§ØªÙŠ (JSON)</button>
      </div>

      <div class="card">
        <div class="row">
          <div>
            <div class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¹Ù†Ø¯Ùƒ</div>
            <div class="value" id="ordersCount">0</div>
          </div>
          <button class="ghost mini" id="clearOrders">Ù…Ø³Ø­ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
        </div>
      </div>
    </div>
  </aside>

  <!-- Modal -->
  <div class="modalWrap" id="modalWrap">
    <div class="modal">
      <header>
        <div>
          <b style="font-size:16px">ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨ Ø¥Ø¹Ù„Ø§Ù†</b>
          <div style="color:var(--muted);font-size:12px;margin-top:4px">Ø§Ù„Ø·Ù„Ø¨ ÙŠÙØ­ÙØ¸ ÙÙˆØ±Ù‹Ø§ â€” ÙˆØ¨ÙƒØ±Ø© Ù†Ø±Ø¨Ø·Ù‡ Ø¨Ù‚ÙˆÙ‚Ù„ Ø´ÙŠØª/ÙˆØ§ØªØ³Ø§Ø¨</div>
        </div>
        <button class="ghost mini" id="closeForm">Ø¥ØºÙ„Ø§Ù‚</button>
      </header>

      <div class="body">
        <div>
          <div class="label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø©</div>
          <input id="f_name" placeholder="Ù…Ø«Ø§Ù„: ÙƒØ§ÙÙŠÙ‡ ÙÙ„Ø§Ù†" />
        </div>
        <div>
          <div class="label">Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„</div>
          <input id="f_phone" placeholder="05xxxxxxxx" />
        </div>

        <div>
          <div class="label">Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</div>
          <select id="f_type">
            <option value="Promo">Ø¹Ø±Ø¶/Ø¨Ø±ÙˆÙ…Ùˆ</option>
            <option value="Brand">ØªØ¹Ø±ÙŠÙ Ø¨Ø§Ù„Ø¹Ù„Ø§Ù…Ø©</option>
            <option value="Opening">Ø§ÙØªØªØ§Ø­</option>
            <option value="Hiring">ØªÙˆØ¸ÙŠÙ</option>
          </select>
        </div>

        <div>
          <div class="label">Ù…Ø¯Ø© Ø§Ù„Ø­Ù…Ù„Ø©</div>
          <select id="f_duration">
            <option value="7">7 Ø£ÙŠØ§Ù…</option>
            <option value="14">14 ÙŠÙˆÙ…</option>
            <option value="30">30 ÙŠÙˆÙ…</option>
          </select>
        </div>

        <div class="full">
          <div class="label">Ù†Øµ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†/Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
          <textarea id="f_notes" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù‚ØµÙŠØ±Ø© + Ø¹Ø±ÙˆØ¶Ùƒ + Ø£ÙŠ ØªÙØ§ØµÙŠÙ„"></textarea>
        </div>

        <div class="full">
          <div class="label">Ù…Ø±ÙÙ‚ (Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ/ØªØµÙ…ÙŠÙ…)</div>
          <input id="f_asset" placeholder="Ø¶Ø¹ Ø±Ø§Ø¨Ø· Drive / Dropbox / YouTubeâ€¦" />
        </div>

        <div class="full card" style="margin:0">
          <div class="label">Ù…Ù„Ø®Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠ</div>
          <div style="margin-top:8px;color:var(--muted);line-height:1.7;font-size:13px">
            <div>ğŸ“ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø´Ø£Ø©: <span id="sum_coords">â€”</span></div>
            <div>ğŸ“º Ø£Ù‚Ø±Ø¨ Ø´Ø§Ø´Ø©: <span id="sum_screen">â€”</span></div>
            <div>ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ©: <span id="sum_dist">â€”</span></div>
            <div>âœ… Ø§Ù„Ø­Ø§Ù„Ø©: <span id="sum_state">â€”</span></div>
          </div>
        </div>
      </div>

      <footer>
        <button class="ghost" id="copyOrder">Ù†Ø³Ø® Ø§Ù„Ø·Ù„Ø¨</button>
        <button class="primary" id="submitOrder">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ (Ø­ÙØ¸)</button>
      </footer>
    </div>
  </div>

  <script>
    // âœ… ØªÙˆÙƒÙ†Ùƒ (Ø£Ù†ØµØ­Ùƒ Ù„Ø§Ø­Ù‚Ù‹Ø§ ØªØ¹Ù…Ù„ Rotate ÙˆØªÙ‚ÙŠÙ‘Ø¯Ù‡ Ø¹Ù„Ù‰ Ø¯ÙˆÙ…ÙŠÙ† Ù…ÙˆÙ‚Ø¹Ùƒ)
    mapboxgl.accessToken = "pk.eyJ1IjoibjktN3Z2IiwiYSI6ImNtbTJubnJjMDA4OGEycXNnaXN2M21lZ3QifQ.yZPWMAgrnQxnwZZdr8kwjA";

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    const SCREEN_FILES = [
      { id: "screen-1", file: "screen-1.geojson" },
      { id: "screen-2", file: "screen-2.geojson" },
      { id: "screen-3", file: "screen-3.geojson" },
      { id: "screen-4", file: "screen-4.geojson" },
      { id: "screen-5", file: "screen-5.geojson" },
    ];

    // Ø¹Ù†Ø§ØµØ± UI
    const el = (id) => document.getElementById(id);
    const sysState = el("sysState");
    const screensState = el("screensState");
    const bizLoc = el("bizLoc");
    const nearestScreen = el("nearestScreen");
    const distanceKm = el("distanceKm");
    const insideState = el("insideState");
    const priceEst = el("priceEst");
    const ordersCount = el("ordersCount");

    const modalWrap = el("modalWrap");
    const openFormBtn = el("openForm");
    const closeFormBtn = el("closeForm");
    const submitOrderBtn = el("submitOrder");
    const copyOrderBtn = el("copyOrder");

    const copyCoordsBtn = el("copyCoords");
    const resetBtn = el("reset");
    const exportOrdersBtn = el("exportOrders");
    const clearOrdersBtn = el("clearOrders");

    // Ø­Ø§Ù„Ø©
    let marker = null;
    let selectedLngLat = null;        // [lng,lat]
    let screens = [];                 // {id, fc, feature, center}
    let insideAny = false;
    let insideScreenId = null;
    let nearest = null;               // {id, distKm}

    // ----- Ø£Ø¯ÙˆØ§Øª Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù„Ùˆ ÙƒØ§Ù†Øª Ù…Ù‚Ù„ÙˆØ¨Ø© -----
    function swapIfLatLng(p) {
      const a = p[0], b = p[1];
      // ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶: lat ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ 24-25 ØŒ lng ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ 46-47
      // Ø¥Ø°Ø§ Ø¬Ø§ÙŠØ© [lat,lng] Ù†Ù‚Ù„Ø¨Ù‡Ø§
      if (a > 15 && a < 35 && b > 35 && b < 60) return [b, a];
      return p;
    }
    function closeRing(ring) {
      if (!ring || ring.length < 3) return ring;
      const first = ring[0];
      const last = ring[ring.length - 1];
      if (first[0] !== last[0] || first[1] !== last[1]) ring.push(first);
      return ring;
    }
    function normalizeFeature(geo) {
      let feature = null;

      if (geo?.type === "FeatureCollection") feature = geo.features?.[0];
      else if (geo?.type === "Feature") feature = geo;
      else if (Array.isArray(geo)) {
        feature = { type:"Feature", properties:{}, geometry:{ type:"Polygon", coordinates:[geo] } };
      } else {
        return null;
      }

      if (!feature?.geometry) return null;

      // MultiPolygon -> Polygon (Ø£ÙˆÙ„ Ù…Ø¶Ù„Ø¹)
      if (feature.geometry.type === "MultiPolygon") {
        feature = {
          type:"Feature",
          properties: feature.properties || {},
          geometry: { type:"Polygon", coordinates: feature.geometry.coordinates[0] }
        };
      }

      if (feature.geometry.type !== "Polygon") return null;

      // Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙ‚Ø·
      let ring = feature.geometry.coordinates[0];
      ring = ring.map(swapIfLatLng);
      ring = closeRing(ring);
      feature.geometry.coordinates[0] = ring;

      return feature;
    }

    // ----- Ø®Ø±ÙŠØ·Ø© -----
    const map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/mapbox/dark-v11",
      center: [46.67, 24.74],
      zoom: 11
    });

    // Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
    const geocoder = new MapboxGeocoder({
      accessToken: mapboxgl.accessToken,
      mapboxgl: mapboxgl,
      marker: false,
      placeholder: "Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø© Ø£Ùˆ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†â€¦",
      proximity: { longitude: 46.67, latitude: 24.74 }
    });
    map.addControl(geocoder, "top-left");

    // ØªØ­Ù…ÙŠÙ„ Ø´Ø§Ø´Ø© ÙˆØ§Ø­Ø¯Ø©
    async function loadScreen(s) {
      const res = await fetch("./" + s.file, { cache: "no-store" });
      if (!res.ok) return null;
      const geo = await res.json();

      const feature = normalizeFeature(geo);
      if (!feature) return null;

      const fc = { type:"FeatureCollection", features:[feature] };
      const center = turf.center(feature).geometry.coordinates; // [lng,lat]
      return { id: s.id, fc, feature, center };
    }

    // Ø±Ø³Ù… ÙƒÙ„ Ø§Ù„Ø´Ø§Ø´Ø§Øª ÙƒÙ€ layers Ù…Ù†ÙØµÙ„Ø©
    function addScreenLayer(screen, idx) {
      const srcId = `src-${screen.id}`;
      const fillId = `fill-${screen.id}`;
      const lineId = `line-${screen.id}`;

      map.addSource(srcId, { type:"geojson", data: screen.fc });

      map.addLayer({
        id: fillId,
        type: "fill",
        source: srcId,
        paint: {
          "fill-color": "#ff6600",
          "fill-opacity": 0.18
        }
      });

      map.addLayer({
        id: lineId,
        type: "line",
        source: srcId,
        paint: {
          "line-color": "#ff6600",
          "line-width": 2
        }
      });
    }

    function setUIReady() {
      sysState.textContent = "Ø¬Ø§Ù‡Ø²";
      sysState.style.borderColor = "rgba(46,204,113,.35)";
      sysState.style.color = "rgba(46,204,113,.95)";
    }

    function setScreensLabel() {
      screensState.textContent = `ØªÙ… ØªØ­Ù…ÙŠÙ„ ${screens.length} Ø´Ø§Ø´Ø©`;
    }

    function prettyCoords(lnglat) {
      if (!lnglat) return "â€”";
      return `${lnglat[1].toFixed(6)}, ${lnglat[0].toFixed(6)}`; // lat, lng
    }

    function computeNearestAndInside(lnglat) {
      const pt = turf.point(lnglat);
      insideAny = false;
      insideScreenId = null;

      // insideØŸ
      for (const s of screens) {
        if (turf.booleanPointInPolygon(pt, s.feature)) {
          insideAny = true;
          insideScreenId = s.id;
          break;
        }
      }

      // Ø£Ù‚Ø±Ø¨ Ø´Ø§Ø´Ø© (Ù…Ø±ÙƒØ²)
      let best = null;
      for (const s of screens) {
        const d = turf.distance(pt, turf.point(s.center), { units:"kilometers" });
        if (!best || d < best.distKm) best = { id: s.id, distKm: d };
      }
      nearest = best;
    }

    function estimatePrice(days, isInside) {
      // ØªØ³Ø¹ÙŠØ± Ù…Ø¨Ø¯Ø¦ÙŠ (ØªÙ‚Ø¯ÙŠØ±ÙŠ) â€” Ø¹Ø¯Ù„Ù‡ ÙƒÙŠÙ ØªØ¨ØºÙ‰ Ù„Ø§Ø­Ù‚Ù‹Ø§
      const basePerWeek = 2000;        // Ù…Ø«Ø§Ù„: Ø£Ø³Ø¨ÙˆØ¹ 2000
      const weeks = Math.max(1, Math.round(days / 7));
      let price = basePerWeek * weeks;

      // Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚: Ù†Ø®Ù„ÙŠÙ‡ â€œØ­Ø¬Ø² Ù…Ø¨Ø¯Ø¦ÙŠâ€/Ø§Ù†ØªØ¸Ø§Ø± ØªÙˆØ³Ø¹Ø©
      if (!isInside) price = Math.round(price * 0.3);

      return price;
    }

    function updateUI() {
      bizLoc.textContent = prettyCoords(selectedLngLat);

      if (!screens.length) {
        nearestScreen.textContent = "â€”";
        distanceKm.textContent = "â€”";
        insideState.textContent = "â€”";
        priceEst.textContent = "â€”";
        return;
      }

      nearestScreen.textContent = nearest ? nearest.id : "â€”";
      distanceKm.textContent = nearest ? `${nearest.distKm.toFixed(2)} ÙƒÙ…` : "â€”";

      if (insideAny) {
        insideState.innerHTML = `<span class="ok">Ø¯Ø§Ø®Ù„ Ù†Ø·Ø§Ù‚ ${insideScreenId} âœ…</span>`;
      } else {
        insideState.innerHTML = `<span class="bad">Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚ âŒ</span>`;
      }

      // Ø§ÙØªØ±Ø§Ø¶ÙŠ 7 Ø£ÙŠØ§Ù… ØªÙ‚Ø¯ÙŠØ±
      const days = parseInt(el("f_duration")?.value || "7", 10);
      const p = estimatePrice(days, insideAny);
      priceEst.textContent = insideAny ? `${p.toLocaleString()} Ø±ÙŠØ§Ù„` : `Ø­Ø¬Ø² Ø§Ù†ØªØ¸Ø§Ø±: ${p.toLocaleString()} Ø±ÙŠØ§Ù„`;
    }

    // Marker + pin
    function setMarker(lnglat) {
      selectedLngLat = lnglat;

      if (marker) marker.remove();
      marker = new mapboxgl.Marker({ color: "#ffffff" }).setLngLat(lnglat).addTo(map);

      computeNearestAndInside(lnglat);
      updateUI();
      updateFormSummary();
    }

    function updateFormSummary() {
      el("sum_coords").textContent = prettyCoords(selectedLngLat);
      el("sum_screen").textContent = nearest ? nearest.id : "â€”";
      el("sum_dist").textContent = nearest ? `${nearest.distKm.toFixed(2)} ÙƒÙ…` : "â€”";
      el("sum_state").innerHTML = insideAny ? "Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚ âœ…" : "Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚ âŒ";
    }

    function openForm() {
      if (!selectedLngLat) {
        alert("Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹ Ù…Ù†Ø´Ø£ØªÙƒ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£ÙˆÙ„Ø§Ù‹");
        return;
      }
      updateFormSummary();
      modalWrap.style.display = "grid";
    }
    function closeForm() {
      modalWrap.style.display = "none";
    }

    function getOrders() {
      try {
        return JSON.parse(localStorage.getItem("wadheex_orders") || "[]");
      } catch {
        return [];
      }
    }
    function setOrders(arr) {
      localStorage.setItem("wadheex_orders", JSON.stringify(arr));
      ordersCount.textContent = String(arr.length);
    }
    function refreshOrdersCount() {
      setOrders(getOrders());
    }

    function buildOrderPayload() {
      const id = "WX-" + Math.random().toString(36).slice(2, 8).toUpperCase() + "-" + Date.now().toString().slice(-4);
      const days = parseInt(el("f_duration").value, 10);
      const price = estimatePrice(days, insideAny);

      return {
        id,
        createdAt: new Date().toISOString(),
        businessName: el("f_name").value.trim(),
        phone: el("f_phone").value.trim(),
        type: el("f_type").value,
        durationDays: days,
        notes: el("f_notes").value.trim(),
        assetLink: el("f_asset").value.trim(),
        coords: selectedLngLat ? { lng: selectedLngLat[0], lat: selectedLngLat[1] } : null,
        inside: insideAny,
        insideScreen: insideScreenId,
        nearestScreen: nearest?.id || null,
        nearestDistanceKm: nearest?.distKm ?? null,
        priceEstimate: price
      };
    }

    function validateOrder(o) {
      if (!o.businessName) return "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø©";
      if (!o.phone) return "Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„";
      if (!o.coords) return "Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ù†Ø´Ø£Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©";
      if (!o.nearestScreen) return "Ù…Ø§ Ù‚Ø¯Ø±Ù†Ø§ Ù†Ø­Ø¯Ø¯ Ø£Ù‚Ø±Ø¨ Ø´Ø§Ø´Ø©";
      return null;
    }

    // ------- Ø£Ø­Ø¯Ø§Ø« UI -------
    openFormBtn.onclick = openForm;
    closeFormBtn.onclick = closeForm;
    modalWrap.addEventListener("click", (e) => {
      if (e.target === modalWrap) closeForm();
    });

    copyCoordsBtn.onclick = async () => {
      if (!selectedLngLat) return alert("Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹ Ø£ÙˆÙ„Ø§Ù‹");
      const text = prettyCoords(selectedLngLat);
      await navigator.clipboard.writeText(text);
      alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª âœ…");
    };

    resetBtn.onclick = () => {
      if (marker) marker.remove();
      marker = null;
      selectedLngLat = null;
      insideAny = false;
      insideScreenId = null;
      nearest = null;
      bizLoc.textContent = "â€”";
      nearestScreen.textContent = "â€”";
      distanceKm.textContent = "â€”";
      insideState.textContent = "â€”";
      priceEst.textContent = "â€”";
      updateFormSummary();
    };

    exportOrdersBtn.onclick = () => {
      const orders = getOrders();
      const blob = new Blob([JSON.stringify(orders, null, 2)], { type:"application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "wadheex-orders.json";
      a.click();
      URL.revokeObjectURL(url);
    };

    clearOrdersBtn.onclick = () => {
      if (!confirm("Ù…ØªØ£ÙƒØ¯ ØªØ¨ØºÙ‰ ØªÙ…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©ØŸ")) return;
      localStorage.removeItem("wadheex_orders");
      refreshOrdersCount();
      alert("ØªÙ… Ø§Ù„Ù…Ø³Ø­ âœ…");
    };

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± Ø¥Ø°Ø§ ØºÙŠÙ‘Ø± Ù…Ø¯Ø© Ø§Ù„Ø­Ù…Ù„Ø© ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    el("f_duration").addEventListener("change", () => {
      updateUI();
      updateFormSummary();
    });

    copyOrderBtn.onclick = async () => {
      const payload = buildOrderPayload();
      const msg = JSON.stringify(payload, null, 2);
      await navigator.clipboard.writeText(msg);
      alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø·Ù„Ø¨ âœ…");
    };

   submitOrderBtn.onclick = () => {

  const payload = buildOrderPayload();
  const err = validateOrder(payload);
  if (err) return alert(err);

  const name = payload.businessName;
  const phone = payload.phone;
  const type = payload.type;
  const days = payload.durationDays;
  const notes = payload.notes || "-";
  const coords = payload.coords ? payload.coords.lat + "," + payload.coords.lng : "-";
  const nearest = payload.nearestScreen || "-";
  const dist = payload.nearestDistanceKm ? payload.nearestDistanceKm.toFixed(2) + " ÙƒÙ…" : "-";
  const inside = payload.inside ? "Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚ âœ…" : "Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚ âŒ";

  const msg =
`Ø·Ù„Ø¨ Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯ - Wadheex Ads

Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø©: ${name}
Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„: ${phone}
Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†: ${type}
Ù…Ø¯Ø© Ø§Ù„Ø­Ù…Ù„Ø©: ${days} ÙŠÙˆÙ…

Ø£Ù‚Ø±Ø¨ Ø´Ø§Ø´Ø©: ${nearest}
Ø§Ù„Ù…Ø³Ø§ÙØ©: ${dist}
Ø§Ù„Ø­Ø§Ù„Ø©: ${inside}

Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø´Ø£Ø©:
${coords}

Ù…Ù„Ø§Ø­Ø¸Ø§Øª:
${notes}
`;

  const phoneNumber = "966583611252"; // ğŸ‘ˆ Ø­Ø· Ø±Ù‚Ù…Ùƒ Ù‡Ù†Ø§ Ø¨Ø¯ÙˆÙ† +

  const url = "https://wa.me/" + phoneNumber + "?text=" + encodeURIComponent(msg);

  window.open(url, "_blank");
}
      const orders = getOrders();
      orders.unshift(payload);
      setOrders(orders);

      closeForm();
      alert(`ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ âœ…\nØ±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${payload.id}\nØ£Ù‚Ø±Ø¨ Ø´Ø§Ø´Ø©: ${payload.nearestScreen}`);
    };

    // ------- ØªÙØ§Ø¹Ù„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© -------
    map.on("click", (e) => {
      setMarker([e.lngLat.lng, e.lngLat.lat]);
    });

    geocoder.on("result", (e) => {
      const c = e?.result?.center; // [lng,lat]
      if (c && c.length === 2) {
        map.flyTo({ center: c, zoom: 13 });
        setMarker(c);
      }
    });

    // ------- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø§Ø´Ø§Øª ÙˆØ±Ø³Ù…Ù‡Ø§ -------
    map.on("load", async () => {
      sysState.textContent = "ØªØ­Ù…ÙŠÙ„â€¦";
      screensState.textContent = "ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø§Ø´Ø§Øªâ€¦";
      screensState.style.color = "var(--muted)";

      const loaded = [];
      for (let i=0; i<SCREEN_FILES.length; i++) {
        const s = await loadScreen(SCREEN_FILES[i]);
        if (s) loaded.push(s);
      }

      screens = loaded;
      setScreensLabel();

      if (!screens.length) {
        screensState.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ø´Ø§Ø´Ø§Øª (Ø§Ø±ÙØ¹ screen-1.geojson)";
        screensState.style.color = "rgba(255,71,87,.95)";
        setUIReady();
        return;
      }

      // Ø§Ø±Ø³Ù… Ø§Ù„ÙƒÙ„
      screens.forEach((s, idx) => addScreenLayer(s, idx));

      // Ø²ÙˆÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„
      const all = { type:"FeatureCollection", features: screens.map(s => s.feature) };
      const bbox = turf.bbox(all);
      map.fitBounds(bbox, { padding: 60, duration: 700 });

      screensState.style.color = "rgba(46,204,113,.95)";
      setUIReady();
      refreshOrdersCount();
      updateUI();
      updateFormSummary();
    });

  </script>
</body>
</html>
