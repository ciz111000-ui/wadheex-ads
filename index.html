<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Wadmmed X</title>

<!-- Mapbox -->
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

<!-- Turf -->
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body,html{
  margin:0;
  padding:0;
  font-family:"Tajawal",sans-serif;
  background:#050509;
  overflow:hidden;
}

/* الخريطة */
#map{
  position:absolute;
  top:0;left:0;
  width:100%;
  height:100%;
}

/* اللوحة الجانبية */
.panel{
  position:fixed;
  right:0;
  top:0;
  width:380px;
  height:100%;
  background:rgba(10,10,15,0.96);
  backdrop-filter:blur(18px);
  border-left:1px solid rgba(255,255,255,0.08);
  padding:18px 20px;
  box-sizing:border-box;
  transform:translateX(100%);
  transition:0.4s ease;
  z-index:999;
  color:#f5f5f5;
  display:flex;
  flex-direction:column;
}
.panel.open{
  transform:translateX(0);
}

.panel-toggle{
  position:fixed;
  right:20px;
  top:20px;
  width:46px;
  height:46px;
  background:rgba(15,15,25,0.9);
  border:1px solid rgba(255,255,255,0.12);
  border-radius:14px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  z-index:1000;
  transition:0.25s;
  color:#fff;
  font-size:22px;
}
.panel-toggle:hover{
  background:rgba(40,40,60,0.95);
  transform:translateY(-1px);
}

/* موبايل */
@media(max-width:768px){
  .panel{
    width:100%;
    height:60%;
    bottom:0;
    top:auto;
    right:0;
    transform:translateY(100%);
    border-left:none;
    border-top:1px solid rgba(255,255,255,0.12);
  }
  .panel.open{
    transform:translateY(0);
  }
  .panel-toggle{
    right:50%;
    transform:translateX(50%);
    top:auto;
    bottom:20px;
  }
}

/* رأس اللوحة */
.panel-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:10px;
}
.panel-title{
  font-size:20px;
  font-weight:700;
}
.panel-subtitle{
  font-size:12px;
  color:#aaa;
}

/* أقسام */
.section{
  background:rgba(255,255,255,0.02);
  border:1px solid rgba(255,255,255,0.06);
  border-radius:14px;
  padding:12px 12px 10px;
  margin-bottom:10px;
}
.section-title{
  font-size:14px;
  font-weight:600;
  margin-bottom:6px;
  color:#e0e0e0;
}

/* الحالة */
.status{
  padding:10px;
  border-radius:10px;
  margin-bottom:8px;
  text-align:center;
  font-weight:600;
  color:#fff;
  font-size:13px;
}
.status.ok{
  background:linear-gradient(135deg,#1b5e20,#2e7d32);
}
.status.no{
  background:linear-gradient(135deg,#7f0000,#b71c1c);
}

/* حقول الإدخال */
.label{
  color:#cfcfcf;
  margin:6px 0 3px;
  font-size:13px;
}
input,select{
  width:100%;
  padding:9px 10px;
  border-radius:9px;
  border:1px solid rgba(255,255,255,0.12);
  margin-bottom:6px;
  background:rgba(10,10,18,0.9);
  color:#fff;
  font-size:13px;
  box-sizing:border-box;
}
input::placeholder{
  color:#777;
}
input:focus,select:focus{
  outline:none;
  border-color:#4caf50;
  background:rgba(15,15,25,0.95);
}

/* أزرار */
button{
  width:100%;
  padding:11px;
  border:none;
  border-radius:10px;
  background:linear-gradient(135deg,#4caf50,#66bb6a);
  color:#fff;
  font-size:15px;
  cursor:pointer;
  margin-top:6px;
  transition:0.25s;
  font-weight:600;
}
button:hover:not(:disabled){
  filter:brightness(1.05);
  transform:translateY(-1px);
}
button:disabled{
  background:#444;
  cursor:not-allowed;
  transform:none;
}

/* زر ثانوي */
.btn-secondary{
  background:linear-gradient(135deg,#3949ab,#5c6bc0);
}

/* السعر والعد التنازلي */
.price-box{
  background:rgba(0,0,0,0.55);
  padding:10px;
  border-radius:10px;
  color:#fff;
  font-size:15px;
  text-align:center;
  margin-top:4px;
  border:1px solid rgba(255,255,255,0.12);
}
.countdown-box{
  margin-top:6px;
  padding:8px;
  border-radius:10px;
  font-size:13px;
  text-align:center;
  background:rgba(255,255,255,0.03);
  border:1px dashed rgba(255,255,255,0.15);
  color:#ddd;
}

/* معلومات المستخدم */
.user-info{
  font-size:12px;
  color:#bdbdbd;
  margin-top:4px;
}

/* Marker */
.marker{
  width:20px;
  height:20px;
  border-radius:50%;
  box-shadow:0 0 10px 4px rgba(255,255,255,0.6);
  cursor:pointer;
}

/* Popup */
.mapboxgl-popup{
  max-width:250px;
  font-family:"Tajawal",sans-serif;
}
.mapboxgl-popup-content{
  background:#111;
  color:#fff;
  border-radius:10px;
  padding:15px;
  border:1px solid #333;
}
</style>
</head>

<body>

<div id="map"></div>

<div class="panel-toggle">☰</div>

<div class="panel" id="panel">
  <div class="panel-header">
    <div>
      <div class="panel-title">حجز شاشة - Wadmmed X</div>
      <div class="panel-subtitle">إدارة إعلاناتك على شاشات الرياض بسهولة</div>
    </div>
  </div>

  <!-- قسم الحساب -->
  <div class="section" id="authSection">
    <div class="section-title">الحساب</div>

    <div id="authForms">
      <div class="label">البريد الإلكتروني</div>
      <input id="authEmail" type="email" placeholder="example@mail.com">

      <div class="label">كلمة المرور</div>
      <input id="authPassword" type="password" placeholder="********">

      <button id="loginBtn" class="btn-secondary">تسجيل الدخول</button>
      <button id="signupBtn" class="btn-secondary" style="margin-top:6px;background:#00897b;">إنشاء حساب جديد</button>
    </div>

    <div id="userPanel" style="display:none;">
      <div class="user-info" id="userInfo"></div>
      <button id="logoutBtn" style="background:#c62828;margin-top:10px;">تسجيل الخروج</button>
    </div>
  </div>

  <!-- حالة الموقع والشاشة -->
  <div id="statusBox" class="status no">لم يتم اختيار موقع</div>

  <!-- بيانات المنشأة -->
  <div class="section">
    <div class="section-title">بيانات المنشأة</div>

    <div class="label">اسم المنشأة</div>
    <input id="orgName" type="text" placeholder="مثال: مطعم الواحة">

    <div class="label">نوع المنشأة</div>
    <select id="orgType">
      <option value="">اختر النوع</option>
      <option>مطعم</option>
      <option>مقهى</option>
      <option>متجر</option>
      <option>شركة</option>
      <option>مؤسسة</option>
    </select>
  </div>

  <!-- تفاصيل الحجز -->
  <div class="section">
    <div class="section-title">تفاصيل الحجز</div>

    <div class="label">عدد الشاشات</div>
    <input id="screenCount" type="number" min="1" value="1">

    <div class="label">تاريخ ووقت البداية</div>
    <input id="startDate" type="datetime-local">

    <div class="label">هل تحتاج تصميم إعلان؟</div>
    <select id="needDesign">
      <option value="no">لا</option>
      <option value="yes">نعم (+800 ريال)</option>
    </select>

    <div class="label">رقم التواصل</div>
    <input id="phone" type="text" placeholder="05xxxxxxxx">

    <div class="price-box" id="priceBox">السعر: 0 ريال</div>
    <div class="countdown-box" id="countdownBox">العد التنازلي سيظهر بعد تأكيد الحجز</div>

    <button id="bookBtn" disabled>إتمام الحجز</button>
  </div>
</div>

<script>
/* إعداد Supabase */
const supabaseUrl = "https://wtoefcpjbudkuqjmymjp.supabase.co";
const supabaseKey = "sb_publishable_1k821wV6u5JuD4MSGZrgnw_RVUNTorK";
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

/* تسجيل محلي احتياطي */
let localUser = null;

/* تحديث واجهة الحساب */
async function refreshUser(){
  try{
    const { data, error } = await supabaseClient.auth.getUser();
    const user = error ? null : data.user;

    if(user){
      document.getElementById("authForms").style.display="none";
      document.getElementById("userPanel").style.display="block";
      document.getElementById("userInfo").textContent="مسجل كـ: "+user.email;
    }else if(localUser){
      document.getElementById("authForms").style.display="none";
      document.getElementById("userPanel").style.display="block";
      document.getElementById("userInfo").textContent="مسجل محلياً كـ: "+localUser.email;
    }else{
      document.getElementById("authForms").style.display="block";
      document.getElementById("userPanel").style.display="none";
    }
  }catch(e){
    if(localUser){
      document.getElementById("authForms").style.display="none";
      document.getElementById("userPanel").style.display="block";
      document.getElementById("userInfo").textContent="مسجل محلياً كـ: "+localUser.email;
    }else{
      document.getElementById("authForms").style.display="block";
      document.getElementById("userPanel").style.display="none";
    }
  }
}

/* تسجيل جديد */
document.getElementById("signupBtn").onclick = async ()=>{
  const email = document.getElementById("authEmail").value.trim();
  const pass = document.getElementById("authPassword").value.trim();

  if(!email || !pass){
    alert("الرجاء إدخال البريد وكلمة المرور");
    return;
  }

  try{
    const { error } = await supabaseClient.auth.signUp({ email, password:pass });
    if(error){
      alert("خطأ في إنشاء الحساب: "+error.message);
      return;
    }
    alert("تم إنشاء الحساب بنجاح، تحقق من بريدك الإلكتروني.");
  }catch(e){
    alert("تعذر الاتصال بالخادم، سيتم استخدام تسجيل محلي.");
    localUser = { email };
    refreshUser();
  }
};

/* تسجيل الدخول */
document.getElementById("loginBtn").onclick = async ()=>{
  const email = document.getElementById("authEmail").value.trim();
  const pass = document.getElementById("authPassword").value.trim();

  if(!email || !pass){
    alert("الرجاء إدخال البريد وكلمة المرور");
    return;
  }

  try{
    const { error } = await supabaseClient.auth.signInWithPassword({ email, password:pass });
    if(error){
      alert("خطأ في تسجيل الدخول: "+error.message);
      return;
    }
    alert("تم تسجيل الدخول بنجاح");
    refreshUser();
  }catch(e){
    alert("تعذر الاتصال بالخادم، سيتم استخدام تسجيل محلي.");
    localUser = { email };
    refreshUser();
  }
};

/* تسجيل الخروج */
document.getElementById("logoutBtn").onclick = async ()=>{
  try{
    await supabaseClient.auth.signOut();
  }catch(e){}
  localUser = null;
  refreshUser();
};

/* إعداد الخريطة */
mapboxgl.accessToken = "pk.eyJ1IjoibjktN3Z2IiwiYSI6ImNtbTJubnJjMDA4OGEycXNnaXN2M21lZ3QifQ.yZPWMAgrnQxnwZZdr8kwjA";

const map = new mapboxgl.Map({
  container:"map",
  style:"mapbox://styles/mapbox/dark-v11",
  center:[46.67,24.75],
  zoom:11,
  minZoom:9,
  maxZoom:16,
  maxBounds:[[46.3,24.4],[47.1,25.1]]
});

map.addControl(new mapboxgl.NavigationControl());

/* الشاشات */
const screens = [
  { name:"شاشة العليا", coords:[46.675,24.713], color:"#ff4444" },
  { name:"شاشة النخيل", coords:[46.72,24.77],  color:"#44ff44" },
  { name:"شاشة الملز",  coords:[46.71,24.65],  color:"#4488ff" }
];

let circles = {};
let selectedScreen = null;

/* رسم الشاشات والدوائر */
screens.forEach((s,i)=>{
  const el = document.createElement("div");
  el.className="marker";
  el.style.background=s.color;
  el.style.boxShadow=`0 0 12px 4px ${s.color}`;

  el.addEventListener("click",()=>{ selectScreen(s); });

  new mapboxgl.Marker(el)
    .setLngLat(s.coords)
    .setPopup(new mapboxgl.Popup().setHTML(`<h3>${s.name}</h3><p>شاشة إعلانية ذكية</p>`))
    .addTo(map);

  const circle = turf.circle(s.coords,7.5,{steps:80,units:"kilometers"});
  circles[s.name]=circle;
});

map.on("load",()=>{
  Object.keys(circles).forEach((key,i)=>{
    map.addSource("circle-"+i,{
      type:"geojson",
      data:circles[key]
    });
    map.addLayer({
      id:"circle-"+i,
      type:"fill",
      source:"circle-"+i,
      paint:{
        "fill-color":"#ffffff",
        "fill-opacity":0.15
      }
    });
  });
});

/* عند الضغط على الخريطة */
map.on("click",(e)=>{
  const pt = [e.lngLat.lng,e.lngLat.lat];

  let nearest = null;
  let minDist = Infinity;

  screens.forEach(s=>{
    const d = turf.distance(pt,s.coords,{units:"kilometers"});
    if(d < minDist){
      minDist = d;
      nearest = s;
    }
  });

  if(minDist <= 7.5){
    selectScreen(nearest,minDist);
  }else{
    selectedScreen = null;
    updateStatus(false);
    resetCircles();
    document.getElementById("bookBtn").disabled=true;
  }
});

/* اختيار شاشة */
function selectScreen(screen,dist=null){
  selectedScreen = screen;
  highlightCircle(screen.name);

  const distance = dist ? dist.toFixed(2) : turf.distance(map.getCenter(),screen.coords,{units:"kilometers"}).toFixed(2);
  const time = Math.round(distance / 7.5 * 10);

  updateStatus(true,screen.name,distance,time);
  document.getElementById("bookBtn").disabled=false;

  updatePrice();
}

/* تحديث الحالة */
function updateStatus(ok,name="",dist="",time=""){
  const box = document.getElementById("statusBox");
  if(ok){
    box.className="status ok";
    box.innerHTML=`${name}<br>المسافة: ${dist} كم<br>الوقت التقريبي بالسيارة: ${time
