<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wadmmed X — منصة الحجز الذكية</title>

<!-- Mapbox -->
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

<!-- Mapbox Geocoder -->
<link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.min.js"></script>

<!-- Turf -->
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* ————————————————————————————————
   الأساسيات
——————————————————————————————— */
:root{
  --panel-width:420px;
  --panel-bg:rgba(10,10,15,0.96);
  --accent:#4caf50;
  --muted:#777;
}
html,body{
  height:100%;
  margin:0;
  font-family:"Tajawal",sans-serif;
  background:#050509;
  overflow:hidden;
}
#map{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
}

/* ————————————————————————————————
   زر القائمة الطولي
——————————————————————————————— */
.panel-toggle{
  position:fixed;
  right:0;
  top:50%;
  transform:translateY(-50%);
  width:56px;
  height:140px;
  background:linear-gradient(180deg,#111,#1b1b1f);
  border:1px solid rgba(255,255,255,0.08);
  border-radius:12px 0 0 12px;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:1100;
  cursor:pointer;
  color:#fff;
  font-weight:700;
  writing-mode:vertical-rl;
  text-orientation:mixed;
  letter-spacing:2px;
  box-shadow:0 6px 18px rgba(0,0,0,0.5);
  user-select:none;
}
.panel-open-toggle-pos{
  right:calc(var(--panel-width) - 18px);
}
@media(max-width:768px){
  .panel-toggle{
    right:50%;
    transform:translateX(50%) translateY(0);
    top:auto;
    bottom:18px;
    width:64px;
    height:46px;
    writing-mode:horizontal-tb;
    border-radius:14px;
  }
  .panel-open-toggle-pos{
    right:50%;
    transform:translateX(50%) translateY(0);
  }
}

/* ————————————————————————————————
   اللوحة الجانبية
——————————————————————————————— */
.panel{
  position:fixed;
  right:0;
  top:0;
  width:var(--panel-width);
  height:100vh;
  background:var(--panel-bg);
  backdrop-filter:blur(14px);
  border-left:1px solid rgba(255,255,255,0.06);
  transform:translateX(100%);
  transition:transform .32s cubic-bezier(.2,.9,.2,1);
  z-index:1050;
  display:flex;
  flex-direction:column;
}
.panel.open{
  transform:translateX(0);
}
.panel-header{
  padding:16px 14px;
  border-bottom:1px solid rgba(255,255,255,0.03);
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.panel-title{
  font-size:18px;
  font-weight:700;
  color:#fff;
}
.panel-subtitle{
  font-size:12px;
  color:var(--muted);
}
.panel-body{
  padding:12px;
  overflow:auto;
  flex:1;
}

/* ————————————————————————————————
   عناصر الإدخال
——————————————————————————————— */
.section{
  background:rgba(255,255,255,0.02);
  border:1px solid rgba(255,255,255,0.04);
  border-radius:12px;
  padding:12px;
  margin-bottom:12px;
}
.section-title{
  font-size:13px;
  color:#e6e6e6;
  margin-bottom:8px;
}
.label{
  color:#cfcfcf;
  font-size:13px;
  margin-bottom:6px;
  display:block;
}
input,select,button{
  font-size:14px;
}
input,select{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.08);
  background:rgba(10,10,18,0.9);
  color:#fff;
  margin-bottom:8px;
}
button{
  width:100%;
  padding:11px;
  border-radius:10px;
  border:none;
  background:linear-gradient(135deg,var(--accent),#66bb6a);
  color:#fff;
  cursor:pointer;
}
button:disabled{
  background:#444;
  cursor:not-allowed;
}
.btn-secondary{
  background:linear-gradient(135deg,#3949ab,#5c6bc0);
}
.small{
  padding:8px;
  font-size:13px;
  border-radius:8px;
}

/* ————————————————————————————————
   صناديق السعر والحالة
——————————————————————————————— */
.price-box{
  padding:10px;
  border-radius:10px;
  background:rgba(0,0,0,0.45);
  color:#fff;
  text-align:center;
  border:1px solid rgba(255,255,255,0.06);
  margin-bottom:8px;
}
.countdown-box{
  padding:8px;
  border-radius:8px;
  background:rgba(255,255,255,0.02);
  color:#ddd;
  text-align:center;
  border:1px dashed rgba(255,255,255,0.06);
}
.status{
  padding:10px;
  border-radius:8px;
  text-align:center;
  font-weight:600;
  color:#fff;
  margin-bottom:10px;
}
.status.ok{
  background:linear-gradient(135deg,#1b5e20,#2e7d32);
}
.status.no{
  background:linear-gradient(135deg,#7f0000,#b71c1c);
}

/* ————————————————————————————————
   نتائج البحث
——————————————————————————————— */
.search-item{
  padding:8px;
  border-radius:8px;
  background:rgba(255,255,255,0.02);
  margin-bottom:6px;
  cursor:pointer;
}
.avail-list{
  font-size:13px;
  color:#ddd;
}
</style>
</head>

<body>

<div id="map"></div>

<button class="panel-toggle" id="panelToggle">القائمة</button>

<div class="panel" id="panel">
  <div class="panel-header">
    <div>
      <div class="panel-title">Wadmmed X</div>
      <div class="panel-subtitle">منصة الحجز الذكية</div>
    </div>
    <button id="closeBtn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;padding:6px 8px;border-radius:8px">إغلاق</button>
  </div>

  <div class="panel-body">

    <!-- ————————————————————————————————
         البحث (Geocoder)
    ———————————————————————————————— -->
    <div class="section">
      <div class="section-title">بحث مكان (مثل Google Maps)</div>
      <div id="geocoder"></div>
    </div>

    <!-- ————————————————————————————————
         الحساب
    ———————————————————————————————— -->
    <div class="section">
      <div class="section-title">الحساب</div>

      <label class="label">البريد الإلكتروني</label>
      <input id="authEmail" type="email" placeholder="example@mail.com">

      <label class="label">كلمة المرور</label>
      <input id="authPassword" type="password" placeholder="********">

      <div style="display:flex;gap:8px">
        <button id="loginBtn" class="btn-secondary">تسجيل الدخول</button>
        <button id="signupBtn" class="btn-secondary" style="background:#00897b">إنشاء حساب</button>
      </div>

      <div id="userPanel" style="display:none;margin-top:8px">
        <div id="userInfo" style="color:#fff;margin-bottom:8px"></div>
        <button id="logoutBtn" style="background:#c62828">تسجيل الخروج</button>
      </div>
    </div>

    <!-- ————————————————————————————————
         بيانات الحجز
    ———————————————————————————————— -->
    <div class="section">
      <div class="section-title">بيانات الحجز</div>

      <label class="label">اسم المنشأة</label>
      <input id="orgName" type="text" placeholder="مثال: مطعم الواحة">

      <label class="label">نوع المنشأة</label>
      <select id="orgType">
        <option value="">اختر النوع</option>
        <option>مطعم</option>
        <option>مقهى</option>
        <option>متجر</option>
        <option>شركة</option>
        <option>مؤسسة</option>
      </select>

      <label class="label">عدد الشاشات</label>
      <input id="screenCount" type="number" min="1" value="1">

      <label class="label">تاريخ ووقت البداية</label>
      <input id="startDate" type="datetime-local">

      <label class="label">مدة العرض بالدقائق</label>
      <input id="durationMinutes" type="number" min="10" value="60">

      <label class="label">هل تحتاج تصميم إعلان؟</label>
      <select id="needDesign">
        <option value="no">لا</option>
        <option value="yes">نعم (+800 ريال)</option>
      </select>

      <label class="label">رقم التواصل</label>
      <input id="phone" type="text" placeholder="05xxxxxxxx">

      <div class="price-box" id="priceBox">السعر: 0 ريال</div>
      <div class="countdown-box" id="countdownBox">العد التنازلي سيظهر بعد تأكيد الحجز</div>

      <button id="bookBtn" disabled>إتمام الحجز</button>
    </div>

    <!-- ————————————————————————————————
         نطاق + توفر
    ———————————————————————————————— -->
    <div class="section">
      <div class="section-title">النطاق والتوفر</div>

      <button id="reserveRangeBtn" class="small" style="background:#2e7d32;margin-bottom:8px">حدد نطاق على الخريطة</button>
      <button id="clearTempRange" class="small" style="background:#666;margin-bottom:8px">إزالة الدائرة</button>

      <div id="availabilityInfo" class="avail-list">اختر شاشة من الخريطة لعرض التوفر.</div>
    </div>

    <!-- ————————————————————————————————
         الخريطة الحرارية
    ———————————————————————————————— -->
    <div class="section">
      <div class="section-title">الخريطة الحرارية</div>
      <div style="display:flex;gap:8px;align-items:center">
        <label style="color:#ddd">عرض الخريطة الحرارية</label>
        <input type="checkbox" id="toggleHeat">
      </div>
    </div>

  </div>
</div>
<script>
/* ————————————————————————————————
   إعداد Supabase
——————————————————————————————— */
const supabaseUrl = "https://wtoefcpjbudkuqjmymjp.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind0b2VmY3BqYnVka3Vxam15bWpwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyMDY4NTksImV4cCI6MjA4Nzc4Mjg1OX0.SZpo2lShgfOdZqNwE74pZUjNovrjO26JE31bRs1xuvg";
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

let ownerWhatsApp = "966583611252"; // رقمك

let authReady = false;
supabaseClient.auth.onAuthStateChange(() => authReady = true);
async function waitAuthReady(){
  while(!authReady) await new Promise(r=>setTimeout(r,100));
}

/* ————————————————————————————————
   Mapbox
——————————————————————————————— */
mapboxgl.accessToken = "pk.eyJ1IjoibjktN3Z2IiwiYSI6ImNtbTJubnJjMDA4OGEycXNnaXN2M21lZ3QifQ.yZPWMAgrnQxnwZZdr8kwjA";

const map = new mapboxgl.Map({
  container: "map",
  style: "mapbox://styles/mapbox/dark-v11",
  center: [46.67,24.75],
  zoom: 11
});
map.addControl(new mapboxgl.NavigationControl());

/* ————————————————————————————————
   الشاشات
——————————————————————————————— */
const screens = [
  { name:"شاشة العليا", coords:[46.675,24.713], color:"#ff4444" },
  { name:"شاشة النخيل", coords:[46.72,24.77],  color:"#44ff44" },
  { name:"شاشة الملز",  coords:[46.71,24.65],  color:"#4488ff" }
];

let selectedScreen = null;
let circles = {};
let searchMarker = null;

/* ————————————————————————————————
   إضافة الشاشات على الخريطة
——————————————————————————————— */
screens.forEach(s=>{
  const el = document.createElement("div");
  el.style.width="20px";
  el.style.height="20px";
  el.style.borderRadius="50%";
  el.style.background=s.color;
  el.style.boxShadow=`0 0 12px 4px ${s.color}`;
  el.style.cursor="pointer";

  el.addEventListener("click", ()=> selectScreen(s));

  new mapboxgl.Marker(el)
    .setLngLat(s.coords)
    .setPopup(new mapboxgl.Popup().setHTML(`<h3>${s.name}</h3>`))
    .addTo(map);

  circles[s.name] = turf.circle(s.coords, 7.5, { steps:80, units:"kilometers" });
});

/* ————————————————————————————————
   Geocoder (بحث مثل Google Maps)
——————————————————————————————— */
const geocoder = new MapboxGeocoder({
  accessToken: mapboxgl.accessToken,
  mapboxgl: mapboxgl,
  placeholder: "ابحث عن مكان…",
  marker: false,
  countries: "sa"
});
document.getElementById("geocoder").appendChild(geocoder.onAdd(map));

geocoder.on("result", (ev)=>{
  const center = ev.result.center;

  if (searchMarker) searchMarker.remove();
  searchMarker = new mapboxgl.Marker({ color:"#ffcc00" })
    .setLngLat(center)
    .addTo(map);

  map.flyTo({ center, zoom:15 });

  const nearest = getNearestScreen(center);
  if (nearest){
    alert(`أقرب شاشة لموقعك هي: ${nearest.screen.name}`);
    selectScreen(nearest.screen, nearest.distance);
  }
});

/* ————————————————————————————————
   حساب أقرب شاشة
——————————————————————————————— */
function getNearestScreen(point){
  let nearest=null, minDist=Infinity;
  screens.forEach(s=>{
    const d = turf.distance(point, s.coords, { units:"kilometers" });
    if (d < minDist){ minDist=d; nearest=s; }
  });
  return { screen:nearest, distance:minDist };
}

/* ————————————————————————————————
   اختيار شاشة
——————————————————————————————— */
function selectScreen(screen, dist=null){
  selectedScreen = screen;

  const distance = dist ?? turf.distance(map.getCenter(), screen.coords, { units:"kilometers" });
  const time = Math.round(distance / 7.5 * 10);

  updateStatus(true, screen.name, distance, time);
  updatePrice(distance);
  renderAvailability(screen.name);

  document.getElementById("bookBtn").disabled = false;
}

/* ————————————————————————————————
   حالة الشاشة
——————————————————————————————— */
function updateStatus(ok, name="", dist="", time=""){
  let box = document.getElementById("statusBox");
  if (!box){
    box = document.createElement("div");
    box.id = "statusBox";
    box.className = "status";
    document.querySelector(".panel-body").prepend(box);
  }

  if (ok){
    box.className = "status ok";
    box.innerHTML = `${name}<br>المسافة: ${dist.toFixed(2)} كم<br>الوقت: ${time} دقيقة`;
  } else {
    box.className = "status no";
    box.innerHTML = "خارج نطاق الشاشات";
  }
}

/* ————————————————————————————————
   حساب السعر
——————————————————————————————— */
function priceForDistance(d){
  if (d <= 2) return 4000;
  if (d <= 5) return 3000;
  return 2000;
}
function updatePrice(dist){
  const count = parseInt(document.getElementById("screenCount").value);
  const needDesign = document.getElementById("needDesign").value === "yes";

  const base = priceForDistance(dist);
  let total = base * count;
  if (needDesign) total += 800;

  const box = document.getElementById("priceBox");
  box.innerHTML = `السعر: ${total} ريال`;

  box.dataset.price = total;
  box.dataset.base = base;
  box.dataset.distance = dist.toFixed(2);
}

/* ————————————————————————————————
   نطاق — اختيار مركز الدائرة
——————————————————————————————— */
let awaitingRangeCenter = false;
let tempRangeId = "temp-range";

document.getElementById("reserveRangeBtn").addEventListener("click", ()=>{
  alert("اضغط على الخريطة لتحديد مركز النطاق");
  awaitingRangeCenter = true;
});

map.on("click", (e)=>{
  if (awaitingRangeCenter){
    awaitingRangeCenter = false;
    const center = [e.lngLat.lng, e.lngLat.lat];
    const radius = parseFloat(prompt("أدخل نصف القطر (كم):", "3"));
    if (!radius) return;
    handleRange(center, radius);
    return;
  }

  const nearest = getNearestScreen([e.lngLat.lng, e.lngLat.lat]);
  if (nearest.distance <= 7.5) selectScreen(nearest.screen, nearest.distance);
});

/* ————————————————————————————————
   معالجة النطاق + إرسال بيانات العميل
——————————————————————————————— */
async function handleRange(center, radiusKm){
  const circle = turf.circle(center, radiusKm, { steps:64, units:"kilometers" });

  if (map.getSource(tempRangeId)) map.getSource(tempRangeId).setData(circle);
  else map.addSource(tempRangeId, { type:"geojson", data:circle });

  if (!map.getLayer(tempRangeId+"-fill"))
    map.addLayer({
      id: tempRangeId+"-fill",
      type:"fill",
      source: tempRangeId,
      paint:{ "fill-color":"#ffcc00", "fill-opacity":0.12 }
    });

  const pts = turf.featureCollection(
    screens.map(s => turf.point(s.coords, { name:s.name }))
  );
  const inside = turf.pointsWithinPolygon(pts, circle);

  if (inside.features.length === 0){
    alert("لا توجد شاشات داخل النطاق");
    return;
  }

  let userEmail = "غير مسجل";
  let userPhone = document.getElementById("phone").value || "غير مدخل";
  let userOrg   = document.getElementById("orgName").value || "غير مدخل";

  try{
    const { data } = await supabaseClient.auth.getUser();
    if (data && data.user) userEmail = data.user.email;
  }catch{}

  let msg = `طلب حجز نطاق\n`;
  msg += `البريد: ${userEmail}\n`;
  msg += `رقم التواصل: ${userPhone}\n`;
  msg += `المنشأة: ${userOrg}\n`;
  msg += `المركز: ${center[1].toFixed(5)}, ${center[0].toFixed(5)}\n`;
  msg += `نصف القطر: ${radiusKm} كم\n\n`;
  msg += `الشاشات داخل النطاق:\n`;

  inside.features.forEach(f=>{
    const s = screens.find(x=>x.name===f.properties.name);
    const d = turf.distance(center, s.coords, { units:"kilometers" });
    msg += `- ${s.name} (${d.toFixed(2)} كم) — ${priceForDistance(d)} ريال\n`;
  });

  window.open(`https://wa.me/${ownerWhatsApp}?text=${encodeURIComponent(msg)}`, "_blank");
  alert("تم إرسال طلب النطاق مع بيانات العميل");
}

/* ————————————————————————————————
   التوفر
——————————————————————————————— */
async function renderAvailability(screenName){
  const box = document.getElementById("availabilityInfo");
  box.innerHTML = "جارٍ التحميل…";

  const { data } = await supabaseClient
    .from("bookings")
    .select("start_date,duration_minutes,phone")
    .eq("screen_name", screenName)
    .order("start_date");

  if (!data || data.length === 0){
    box.innerHTML = "لا توجد حجوزات لهذه الشاشة";
    return;
  }

  box.innerHTML = data.map(b=>{
    const s = new Date(b.start_date);
    const e = new Date(s.getTime() + (b.duration_minutes||60)*60000);
    return `<div style="margin-bottom:6px;padding:8px;background:rgba(255,255,255,0.05);border-radius:8px">
      ${s.toLocaleString()} — ${e.toLocaleString()}<br>
      ${b.phone}
    </div>`;
  }).join("");
}

/* ————————————————————————————————
   منع تداخل الحجوزات
——————————————————————————————— */
async function isOverlapping(screenName, startISO, duration){
  const newStart = new Date(startISO);
  const newEnd = new Date(newStart.getTime() + duration*60000);

  const { data } = await supabaseClient
    .from("bookings")
    .select("start_date,duration_minutes")
    .eq("screen_name", screenName);

  for (const b of data){
    const s = new Date(b.start_date);
    const e = new Date(s.getTime() + (b.duration_minutes||60)*60000);
    if (newStart < e && s < newEnd) return true;
  }
  return false;
}

/* ————————————————————————————————
   تنفيذ الحجز
——————————————————————————————— */
document.getElementById("bookBtn").addEventListener("click", async ()=>{

  if (!selectedScreen){
    alert("اختر شاشة أولاً");
    return;
  }

  const orgName = document.getElementById("orgName").value.trim();
  const orgType = document.getElementById("orgType").value;
  const startDate = document.getElementById("startDate").value;
  const phone = document.getElementById("phone").value.trim();
  const duration = parseInt(document.getElementById("durationMinutes").value);

  if (!orgName || !orgType || !startDate || !/^05\d{8}$/.test(phone)){
    alert("أكمل البيانات بشكل صحيح");
    return;
  }

  if (await isOverlapping(selectedScreen.name, startDate, duration)){
    alert("يوجد حجز متداخل");
    return;
  }

  let userEmail = null;
  try{
    const { data } = await supabaseClient.auth.getUser();
    if (data && data.user) userEmail = data.user.email;
  }catch{}

  if (!userEmail){
    const emailInput = document.getElementById("authEmail").value.trim();
    if (!emailInput){
      alert("سجّل دخول أو أدخل بريد لإنشاء حساب تلقائي");
      return;
    }
    const tempPass = Math.random().toString(36).slice(-10)+"A1!";
    await supabaseClient.auth.signUp({ email:emailInput, password:tempPass });
    userEmail = emailInput;
  }

  const price = document.getElementById("priceBox").dataset.price;
  const base = document.getElementById("priceBox").dataset.base;
  const dist = document.getElementById("priceBox").dataset.distance;

  await supabaseClient.from("bookings").insert([{
    user_email:userEmail,
    org_name:orgName,
    org_type:orgType,
    screen_name:selectedScreen.name,
    screen_count:parseInt(document.getElementById("screenCount").value),
    start_date:startDate,
    duration_minutes:duration,
    need_design:document.getElementById("needDesign").value==="yes",
    phone,
    price_text:`${price} ريال`,
    price_value:parseInt(price),
    base_price:parseInt(base),
    distance_km:parseFloat(dist),
    created_at:new Date().toISOString()
  }]);

  const msg = encodeURIComponent(
    `طلب حجز شاشة\n`+
    `المستخدم: ${userEmail}\n`+
    `المنشأة: ${orgName} (${orgType})\n`+
    `الشاشة: ${selectedScreen.name}\n`+
    `السعر: ${price} ريال\n`+
    `المسافة: ${dist} كم\n`+
    `البداية: ${startDate}\n`+
    `المدة: ${duration} دقيقة\n`+
    `رقم التواصل: ${phone}`
  );

  window.open(`https://wa.me/${ownerWhatsApp}?text=${msg}`, "_blank");
  alert("تم إرسال طلب الحجز");
});

/* ————————————————————————————————
   تسجيل الدخول / تسجيل جديد
——————————————————————————————— */
document.getElementById("signupBtn").addEventListener("click", async ()=>{
  const email = document.getElementById("authEmail").value.trim();
  const pass = document.getElementById("authPassword").value.trim();
  if (!email || !pass){ alert("أدخل البريد وكلمة المرور"); return; }
  await supabaseClient.auth.signUp({ email, password:pass });
  alert("تم إنشاء الحساب");
});

document.getElementById("loginBtn").addEventListener("click", async ()=>{
  const email = document.getElementById("authEmail").value.trim();
  const pass = document.getElementById("authPassword").value.trim();
  const { error } = await supabaseClient.auth.signInWithPassword({ email, password:pass });
  if (error) alert("خطأ في تسجيل الدخول");
  else alert("تم تسجيل الدخول");
});

document.getElementById("logoutBtn").addEventListener("click", async ()=>{
  await supabaseClient.auth.signOut();
  alert("تم تسجيل الخروج");
});

/* ————————————————————————————————
   فتح/إغلاق اللوحة
——————————————————————————————— */
const panel = document.getElementById("panel");
const toggle = document.getElementById("panelToggle");
const closeBtn = document.getElementById("closeBtn");

toggle.onclick = ()=> panel.classList.toggle("open");
closeBtn.onclick = ()=> panel.classList.remove("open");
</script>
</body>
</html>
