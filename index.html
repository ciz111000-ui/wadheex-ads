<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Wadheex X – Stable Pro</title>

<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<style>
:root{
  --bg:#0b0b15;
  --glass:rgba(15,15,25,.6);
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#fff;font-family:system-ui}

.header{
  height:70px;background:#0b0b15;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 20px;border-bottom:1px solid rgba(255,255,255,.08);
  position:sticky;top:0;z-index:20;
}
.logo{font-weight:bold;font-size:22px;color:#00e0ff}

.map-wrap{position:relative;height:calc(100vh - 70px)}
#map{position:absolute;inset:0}

.panel{
  position:absolute;top:0;right:0;
  width:380px;height:100%;
  background:var(--glass);
  backdrop-filter:blur(18px);
  border-left:1px solid rgba(255,255,255,.08);
  padding:20px;z-index:10;
  transition:.35s;
}
.panel.collapsed{transform:translateX(340px)}

.toggle{
  position:absolute;left:-40px;top:50%;
  transform:translateY(-50%);
  width:40px;height:80px;
  background:rgba(20,20,35,.95);
  border-radius:10px 0 0 10px;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:20px;
}

.panel input, .panel select{
  width:100%;padding:12px;margin:10px 0;
  background:#0f0f18;border:1px solid #222;
  color:#fff;border-radius:6px;
}
.panel button{
  width:100%;padding:14px;margin-top:10px;
  background:linear-gradient(90deg,#8a2be2,#b26cff);
  border:none;color:#fff;border-radius:8px;
  font-size:16px;cursor:pointer;
}
.status{margin:10px 0;font-weight:bold}

@media(max-width:900px){
  .panel{
    width:100%;height:65%;
    top:auto;bottom:0;border-left:none;
    border-top:1px solid rgba(255,255,255,.08);
    border-radius:20px 20px 0 0;
    overflow-y:auto;
  }
  .panel.collapsed{transform:translateY(85%)}
  .toggle{
    left:50%;top:-18px;
    transform:translate(-50%,-50%);
    width:70px;height:30px;border-radius:12px;
  }
}
</style>
</head>
<body>

<header class="header">
  <div class="logo">W X</div>
</header>

<section class="map-wrap">
  <div id="map"></div>

  <div class="panel collapsed" id="panel">
    <div class="toggle" onclick="togglePanel()">☰</div>

    <h3>حجز مساحة إعلانية (أسبوع)</h3>

    <div id="screenName">اختر موقع على الخريطة</div>
    <div id="duration"></div>
    <div id="price"></div>
    <div class="status" id="status"></div>

    <input id="bizName" placeholder="اسم المنشأة"/>

    <select id="bizType">
      <option value="">نوع المنشأة</option>
      <option>مطعم</option>
      <option>كافيه</option>
      <option>متجر</option>
      <option>عيادة</option>
      <option>شركة</option>
      <option>تطبيق</option>
      <option>جهة حكومية</option>
      <option>أخرى</option>
    </select>

    <input id="adNote" placeholder="وصف مختصر للإعلان (اختياري)"/>

    <select id="screensCount">
      <option value="1">شاشة واحدة</option>
      <option value="2">شاشتين</option>
      <option value="3">ثلاث شاشات</option>
      <option value="all">جميع الشاشات</option>
    </select>

    <label>تاريخ ووقت بداية الإعلان</label>
    <input id="startDateTime" type="datetime-local"/>

    <label>هل تحتاج تصميم إعلان؟</label>
    <select id="needDesign">
      <option value="no">لا، لدي تصميم جاهز</option>
      <option value="yes">نعم، أحتاج تصميم (+800 ريال)</option>
    </select>

    <input id="phone" placeholder="رقم التواصل 05XXXXXXXX" />

    <button id="bookBtn" disabled onclick="confirmBooking()">تأكيد الحجز</button>
  </div>
</section>

<script>
mapboxgl.accessToken="pk.eyJ1IjoibjktN3Z2IiwiYSI6ImNtbTJubnJjMDA4OGEycXNnaXN2M21lZ3QifQ.yZPWMAgrnQxnwZZdr8kwjA";

const map=new mapboxgl.Map({
  container:"map",
  style:"mapbox://styles/mapbox/dark-v11",
  center:[46.67,24.75],
  zoom:11
});

map.addControl(new mapboxgl.NavigationControl());

const MAX_KM=8;

const screens=[
 { name:"Screen A – الياسمين", coords:[46.67,24.74], color:"#ff3b3b"},
 { name:"Screen B – النرجس", coords:[46.63,24.79], color:"#2b8cff"},
 { name:"Screen C – الملقا", coords:[46.70,24.78], color:"#a855f7"}
];

let selected=null;
let circleIds=[];

map.on("load",()=>{
  screens.forEach((screen,i)=>{
    new mapboxgl.Marker({color:screen.color})
      .setLngLat(screen.coords).addTo(map);

    const circle=turf.circle(screen.coords,MAX_KM,{steps:80,units:"kilometers"});
    const id="circle-"+i;
    circleIds.push(id);

    map.addSource(id,{type:"geojson",data:circle});
    map.addLayer({
      id:id,type:"fill",source:id,
      paint:{
        "fill-color":screen.color,
        "fill-opacity":0.15
      }
    });
  });

  const now=new Date();
  now.setMinutes(now.getMinutes()-now.getTimezoneOffset());
  document.getElementById("startDateTime").min=
    now.toISOString().slice(0,16);
});

map.on("click",(e)=>{
  const point=[e.lngLat.lng,e.lngLat.lat];

  let inside=[];
  screens.forEach((screen,i)=>{
    const d=turf.distance(
      turf.point(point),
      turf.point(screen.coords),
      {units:"kilometers"}
    );
    if(d<=MAX_KM){
      inside.push({screen,index:i,distance:d});
    }
  });

  const status=document.getElementById("status");
  const btn=document.getElementById("bookBtn");

  if(inside.length===0){
    status.innerText="❌ خارج نطاق 10 دقائق";
    btn.disabled=true; selected=null; return;
  }

  inside.sort((a,b)=>a.distance-b.distance);
  selected=inside[0];

  updatePrice();
  status.innerText="✅ داخل نطاق 10 دقائق";
  btn.disabled=false;
});

function updatePrice(){
  let basePrice=
    selected.distance<=2?4000:
    selected.distance<=5?3000:2000;

  let count=document.getElementById("screensCount").value;
  let design=document.getElementById("needDesign").value;

  let multiplier=count==="all"?3:parseInt(count);
  let designFee=design==="yes"?800:0;

  let total=(basePrice*multiplier)+designFee;

  document.getElementById("price").innerText="السعر: "+total+" ريال";
}

document.getElementById("screensCount").addEventListener("change",updatePrice);
document.getElementById("needDesign").addEventListener("change",updatePrice);

function togglePanel(){
  document.getElementById("panel").classList.toggle("collapsed");
}

function confirmBooking(){
  const phone=document.getElementById("phone").value;

  if(!/^05\d{8}$/.test(phone)){
    alert("أدخل رقم سعودي صحيح يبدأ بـ 05");
    return;
  }

  alert("تم استلام طلبك بنجاح ✅");
}
</script>

</body>
</html>
