<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Wadheex X – Smart Engine</title>

<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<style>
body{margin:0;background:#0b0b15;color:#fff;font-family:system-ui}
#map{position:absolute;inset:0}

.panel{
position:absolute;
top:0;right:0;
width:380px;height:100%;
background:rgba(15,15,25,.6);
backdrop-filter:blur(20px);
padding:25px;
z-index:10;
border-left:1px solid rgba(255,255,255,.08);
transition:.4s;
}

h3{margin-top:0}
.info{margin:10px 0}
button{
width:100%;
padding:14px;
background:linear-gradient(90deg,#8a2be2,#b26cff);
border:none;color:#fff;cursor:pointer;
}
button:disabled{opacity:.4}

.pulse{
animation:pulse 1.8s infinite;
}
@keyframes pulse{
0%{filter:drop-shadow(0 0 5px currentColor)}
50%{filter:drop-shadow(0 0 25px currentColor)}
100%{filter:drop-shadow(0 0 5px currentColor)}
}
</style>
</head>
<body>

<div id="map"></div>

<div class="panel" id="panel">
<h3>محرك وميض الذكي</h3>
<div class="info" id="screenName">اختر موقع على الخريطة</div>
<div class="info" id="duration"></div>
<div class="info" id="price"></div>
<div class="info" id="status"></div>
<button id="bookBtn" disabled>تأكيد الحجز</button>
</div>

<script>

mapboxgl.accessToken="pk.eyJ1IjoibjktN3Z2IiwiYSI6ImNtbTJubnJjMDA4OGEycXNnaXN2M21lZ3QifQ.yZPWMAgrnQxnwZZdr8kwjA";

const map=new mapboxgl.Map({
container:"map",
style:"mapbox://styles/mapbox/dark-v11",
center:[46.67,24.75],
zoom:11
});

// نفترض 10 دقائق ≈ 8 كم
const MAX_KM=8;

const screens=[
{ name:"Screen A – الياسمين", coords:[46.67,24.74], color:"#ff3b3b"},
{ name:"Screen B – النرجس", coords:[46.63,24.79], color:"#2b8cff"},
{ name:"Screen C – الملقا", coords:[46.70,24.78], color:"#a855f7"}
];

let circleIds=[];

map.on("load",()=>{

screens.forEach((screen,i)=>{

new mapboxgl.Marker({color:screen.color})
.setLngLat(screen.coords)
.addTo(map);

const circle=turf.circle(screen.coords,MAX_KM,{
steps:80,
units:"kilometers"
});

const id="circle-"+i;
circleIds.push(id);

map.addSource(id,{type:"geojson",data:circle});

map.addLayer({
id:id,
type:"fill",
source:id,
paint:{
"fill-color":screen.color,
"fill-opacity":0.15
}
});

});

});

map.on("click",(e)=>{

const point=[e.lngLat.lng,e.lngLat.lat];

if(window.userMarker)window.userMarker.remove();
window.userMarker=new mapboxgl.Marker({color:"#00ffff"})
.setLngLat(point)
.addTo(map);

let inside=[];
let distances=[];

screens.forEach((screen,i)=>{

const d=turf.distance(
turf.point(point),
turf.point(screen.coords),
{units:"kilometers"}
);

distances.push({screen,index:i,distance:d});

if(d<=MAX_KM) inside.push({screen,index:i,distance:d});

});

// reset opacity
circleIds.forEach(id=>{
map.setPaintProperty(id,"fill-opacity",0.08);
});

if(inside.length===0){
document.getElementById("status").innerText="❌ خارج نطاق 10 دقائق";
document.getElementById("bookBtn").disabled=true;
return;
}

// لو داخل أكثر من نطاق
inside.sort((a,b)=>a.distance-b.distance);

const chosen=inside[0];

map.setPaintProperty(
circleIds[chosen.index],
"fill-opacity",
0.35
);

const minutes=(chosen.distance/8)*10;

let price=
chosen.distance<=2?4000:
chosen.distance<=5?3000:
2000;

document.getElementById("screenName").innerText=chosen.screen.name;
document.getElementById("duration").innerText="وقت الوصول التقريبي: "+minutes.toFixed(1)+" دقيقة";
document.getElementById("price").innerText="السعر: "+price+" ريال";
document.getElementById("status").innerText="✅ داخل نطاق 10 دقائق";
document.getElementById("bookBtn").disabled=false;

// تلوين اللوحة حسب الشاشة
document.getElementById("panel").style.borderLeft="4px solid "+chosen.screen.color;

});

</script>

</body>
</html>
