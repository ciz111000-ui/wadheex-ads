<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wadheex X | منصة الحجز الذاتي</title>

<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.1/mapbox-gl-geocoder.css" />
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.1/mapbox-gl-geocoder.min.js"></script>

<style>
:root{
  --primary:#ff3b3b;
  --blue:#007bff;
  --bg:#0f1724;
  --card:#121b2e;
}

html,body{
  margin:0;
  height:100%;
  font-family:system-ui;
  background:var(--bg);
  color:#fff;
}

#map{
  position:absolute;
  top:0;
  left:0;
  right:0;
  bottom:0;
}

.panel{
  position:absolute;
  top:0;
  right:0;
  width:380px;
  max-width:100%;
  height:100%;
  background:var(--card);
  padding:20px;
  overflow:auto;
  z-index:10;
  box-shadow:-10px 0 30px rgba(0,0,0,.4);
}

.panel h2{
  margin-top:0;
}

.input{
  width:100%;
  padding:10px;
  margin:6px 0;
  border-radius:8px;
  border:none;
}

.btn{
  width:100%;
  padding:12px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  margin-top:10px;
  font-weight:bold;
}

.btn-primary{background:var(--primary);color:#fff;}
.btn-blue{background:var(--blue);color:#fff;}

.stat{
  background:#1c2740;
  padding:10px;
  margin-top:8px;
  border-radius:8px;
  font-size:14px;
}

.preview-box{
  background:#000;
  height:120px;
  display:flex;
  align-items:center;
  justify-content:center;
  margin-top:10px;
  border-radius:8px;
  font-weight:bold;
}

@media(max-width:900px){
  .panel{
    width:100%;
    height:50%;
    bottom:0;
    top:auto;
    border-radius:20px 20px 0 0;
  }
}
</style>
</head>
<body>

<div id="map"></div>

<aside class="panel">
  <h2>Wadheex X</h2>

  <input id="businessName" class="input" placeholder="اسم المنشأة" />
  <input id="phoneInput" class="input" placeholder="رقم التواصل" />

  <div class="stat" id="distanceStat">المسافة: -</div>
  <div class="stat" id="priceStat">السعر: -</div>
  <div class="stat" id="etaStat">وقت الوصول: -</div>
  <div class="stat" id="aiStat">مؤشر الموقع: -</div>

  <button class="btn btn-blue" onclick="previewAd()">معاينة الإعلان</button>
  <div class="preview-box" id="previewBox">هنا يظهر إعلانك</div>

  <button class="btn btn-primary" onclick="submitOrder()">حجز عبر واتساب</button>
  <button class="btn btn-blue" onclick="downloadDetails()">تحميل التفاصيل</button>
</aside>

<script>
mapboxgl.accessToken = "PUT_YOUR_MAPBOX_TOKEN_HERE";

const screens = [
  {name:"Screen-1", coords:[46.61106,24.77635]},
  {name:"Screen-2", coords:[46.65000,24.80000]},
  {name:"Screen-3", coords:[46.70000,24.75000]}
];

const map = new mapboxgl.Map({
  container:"map",
  style:"mapbox://styles/mapbox/dark-v11",
  center:[46.67,24.75],
  zoom:11
});

map.addControl(new mapboxgl.NavigationControl(),"bottom-right");

const geocoder = new MapboxGeocoder({
  accessToken:mapboxgl.accessToken,
  mapboxgl:mapboxgl,
  marker:false,
  countries:"sa",
  language:"ar",
  placeholder:"ابحث عن منشأة..."
});

map.addControl(geocoder,"top-left");

let userMarker=null;
let selectedScreen=null;

screens.forEach(screen=>{
  new mapboxgl.Marker({color:"#ff0000"})
    .setLngLat(screen.coords)
    .setPopup(new mapboxgl.Popup().setText(screen.name))
    .addTo(map);
});

function calculateNearest(lng,lat){
  let minDist=Infinity;
  screens.forEach(screen=>{
    const dist=turf.distance(
      turf.point([lng,lat]),
      turf.point(screen.coords)
    );
    if(dist<minDist){
      minDist=dist;
      selectedScreen=screen;
    }
  });
  return minDist;
}

function pricing(dist){
  if(dist<=2)return 4000;
  if(dist<=5)return 3000;
  return 2000;
}

function aiScore(dist){
  return Math.max(50,100 - Math.round(dist*10));
}

function updateStats(lng,lat){
  const dist=calculateNearest(lng,lat);
  const price=pricing(dist);
  const eta=Math.round((dist/50)*60);

  document.getElementById("distanceStat").innerText="المسافة: "+dist.toFixed(2)+" كم";
  document.getElementById("priceStat").innerText="السعر: "+price+" ريال";
  document.getElementById("etaStat").innerText="وقت الوصول: "+eta+" دقيقة";
  document.getElementById("aiStat").innerText="مؤشر الموقع: "+aiScore(dist)+"/100";
}

map.on("click",e=>{
  if(userMarker)userMarker.remove();
  userMarker=new mapboxgl.Marker({color:"#007bff"})
    .setLngLat(e.lngLat)
    .addTo(map);

  updateStats(e.lngLat.lng,e.lngLat.lat);
});

geocoder.on("result",ev=>{
  const [lng,lat]=ev.result.center;
  if(userMarker)userMarker.remove();
  userMarker=new mapboxgl.Marker({color:"#007bff"})
    .setLngLat([lng,lat])
    .addTo(map);

  map.flyTo({center:[lng,lat],zoom:15});
  updateStats(lng,lat);
});

function previewAd(){
  const name=document.getElementById("businessName").value||"اسم منشأتك";
  document.getElementById("previewBox").innerText=name;
}

function submitOrder(){
  if(!selectedScreen){alert("حدد موقع أولاً");return;}
  const name=document.getElementById("businessName").value;
  const price=document.getElementById("priceStat").innerText;

  const msg=encodeURIComponent(
    "طلب حجز إعلان\n"+
    "المنشأة: "+name+"\n"+
    price+"\n"+
    "الشاشة: "+selectedScreen.name
  );

  window.open("https://wa.me/966583611252?text="+msg,"_blank");
}

function downloadDetails(){
  const data={
    business:document.getElementById("businessName").value,
    screen:selectedScreen?selectedScreen.name:null,
    price:document.getElementById("priceStat").innerText
  };
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="wadheex-details.json";
  a.click();
}
</script>

</body>
</html>
